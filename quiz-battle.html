<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quiz Battle - ডোপামিন</title>
  <link href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
    :root {
      --primary-color: #6b48ff;
      --background-color: #f4f4f4;
      --text-color: #333;
      --card-bg: #fff;
    }
    [data-theme="dark"] {
      --primary-color: #a594fd;
      --background-color: #1a1a1a;
      --text-color: #f4f4f4;
      --card-bg: #2c2c2c;
    }
    body { font-family: Arial, sans-serif; background: var(--background-color); color: var(--text-color); margin: 0; padding: 20px; }
    .battle-container { max-width: 800px; margin: auto; background: var(--card-bg); padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .question { font-size: 1.2em; margin-bottom: 20px; }
    .options button { display: block; margin: 10px 0; padding: 10px; width: 100%; background: var(--primary-color); color: #fff; border: none; border-radius: 4px; cursor: pointer; }
    .options button:hover { background: #5439cc; }
    .leaderboard { margin-top: 20px; }
    .timer { font-weight: bold; color: red; margin-bottom: 10px; }
    .btn { background: var(--primary-color); color: #fff; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
    .btn:hover { background: #5439cc; }
    .form-group { margin-bottom: 15px; }
    .form-control { width: 100%; padding: 8px; border-radius: 4px; }
    #join-section, #battle-section { padding: 20px; }
    #battle-code-display { margin-top: 10px; }
    @media (max-width: 767px) { .battle-container { padding: 10px; } }
  </style>
</head>
<body>
  <div class="battle-container">
    <h1>Quiz Battle</h1>
    <div id="join-section">
      <button class="btn" onclick="startQuizBattle()">Create New Quiz Battle</button>
      <div class="form-group">
        <label for="battle-code">Enter Battle Code (e.g., QUIZ123)</label>
        <input type="text" id="battle-code" class="form-control" placeholder="QUIZ123">
      </div>
      <button class="btn" onclick="joinBattle()">Join Battle</button>
      <div id="battle-code-display" style="display: none;">
        Room Code: <span id="code"></span>
        <button class="btn" onclick="copyCode()">Copy Code</button>
      </div>
    </div>
    <div id="battle-section" style="display: none;">
      <div class="timer" id="timer">Time: 15s</div>
      <div class="question" id="question"></div>
      <div class="options" id="options"></div>
      <div class="leaderboard" id="leaderboard"></div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <script>
    // Replace with your Firebase configuration from dashboard.html
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;
    let currentBattleId = null;
    let timerInterval = null;

    auth.onAuthStateChanged(user => {
      if (!user) return window.location.href = 'auth.html';
      currentUser = user;
      const urlParams = new URLSearchParams(window.location.search);
      const battleCode = urlParams.get('code');
      if (battleCode) {
        document.getElementById('battle-code').value = battleCode;
        joinBattle();
      }
    });

    async function startQuizBattle() {
      if (!currentUser) {
        Toastify({ text: 'Please log in to start a quiz battle!', style: { background: '#dc3545' } }).showToast();
        return;
      }
      const battleId = 'QUIZ' + Math.random().toString(36).substr(2, 5).toUpperCase();
      const questions = await loadQuestions();
      await db.collection('quizBattles').doc(battleId).set({
        state: {
          currentQuestion: 1,
          startTime: firebase.firestore.FieldValue.serverTimestamp(),
          status: 'active',
          timePerQuestion: 15,
          isPublic: true
        },
        participants: {
          [currentUser.uid]: { name: currentUser.displayName || 'User', score: 0, answers: {} }
        },
        questions: questions.slice(0, 5)
      });
      currentBattleId = battleId;
      document.getElementById('battle-code').value = battleId;
      document.getElementById('battle-code-display').style.display = 'block';
      document.getElementById('code').textContent = battleId;
      Toastify({ text: `Quiz Battle Created! Code: ${battleId}`, style: { background: '#6b48ff' } }).showToast();
      joinBattle();
    }

    async function joinBattle() {
      const battleCode = document.getElementById('battle-code').value.toUpperCase();
      if (!battleCode) {
        Toastify({ text: 'Enter a valid code!', style: { background: '#dc3545' } }).showToast();
        return;
      }

      const battleRef = db.collection('quizBattles').doc(battleCode);
      const doc = await battleRef.get();
      if (!doc.exists) {
        Toastify({ text: 'Invalid battle code!', style: { background: '#dc3545' } }).showToast();
        return;
      }

      currentBattleId = battleCode;
      await battleRef.update({
        [`participants.${currentUser.uid}`]: {
          name: currentUser.displayName || 'User',
          score: 0,
          answers: {}
        }
      });

      document.getElementById('join-section').style.display = 'none';
      document.getElementById('battle-section').style.display = 'block';
      document.getElementById('battle-code-display').style.display = 'block';
      document.getElementById('code').textContent = battleCode;
      startBattle(battleRef);
    }

    function startBattle(battleRef) {
      battleRef.onSnapshot(doc => {
        if (!doc.exists) return endBattle();
        const data = doc.data();
        if (data.state.status !== 'active') return endBattle();

        const q = data.questions[data.state.currentQuestion - 1];
        if (!q) return endBattle();
        document.getElementById('question').textContent = q.text;
        const optionsDiv = document.getElementById('options');
        optionsDiv.innerHTML = '';
        q.options.forEach(opt => {
          const btn = document.createElement('button');
          btn.textContent = opt;
          btn.onclick = () => submitAnswer(battleRef, q.id, opt, q.correctAnswer);
          optionsDiv.appendChild(btn);
        });

        const leaderboard = document.getElementById('leaderboard');
        leaderboard.innerHTML = '<h3>Leaderboard</h3>';
        Object.entries(data.participants).forEach(([id, p]) => {
          leaderboard.innerHTML += `<p>${p.name}: ${p.score}</p>`;
        });

        if (timerInterval) clearInterval(timerInterval);
        const startTime = data.state.startTime.toDate().getTime();
        const timePerQuestion = data.state.timePerQuestion * 1000;
        timerInterval = setInterval(async () => {
          const timeLeft = Math.max(0, Math.floor((startTime + timePerQuestion - Date.now()) / 1000));
          document.getElementById('timer').textContent = `Time: ${timeLeft}s`;
          if (timeLeft <= 0) {
            clearInterval(timerInterval);
            await battleRef.update({
              'state.currentQuestion': firebase.firestore.FieldValue.increment(1),
              'state.startTime': firebase.firestore.FieldValue.serverTimestamp()
            });
          }
        }, 1000);
      });
    }

    async function submitAnswer(battleRef, questionId, answer, correctAnswer) {
      const points = answer === correctAnswer ? 10 : 0;
      await battleRef.update({
        [`participants.${currentUser.uid}.answers.${questionId}`]: answer,
        [`participants.${currentUser.uid}.score`]: firebase.firestore.FieldValue.increment(points)
      });
      Toastify({
        text: answer === correctAnswer ? 'Correct! +10 points' : 'Wrong!',
        style: { background: answer === correctAnswer ? '#28a745' : '#dc3545' }
      }).showToast();
    }

    function endBattle() {
      clearInterval(timerInterval);
      document.getElementById('battle-section').innerHTML = '<h2>Battle Ended!</h2>';
      Toastify({ text: 'Quiz Battle Ended!', style: { background: '#6b48ff' } }).showToast();
    }

    function copyCode() {
      const code = document.getElementById('code').textContent;
      navigator.clipboard.writeText(code).then(() => {
        Toastify({ text: 'Code copied!', style: { background: '#6b48ff' } }).showToast();
      });
    }

    async function loadQuestions() {
      try {
        const response = await fetch('questions.json'); // Update with your JSON file path
        if (!response.ok) throw new Error('Failed to load questions');
        return await response.json();
      } catch (error) {
        Toastify({ text: 'Error loading questions!', style: { background: '#dc3545' } }).showToast();
        return [];
      }
    }
  </script>
</body>
</html>
