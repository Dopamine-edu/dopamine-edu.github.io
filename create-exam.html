<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>পরীক্ষা নির্মাতা</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" rel="stylesheet"/>
  <style>
    body { font-family: 'Hind Siliguri', sans-serif; background: #f5f5f5; padding: 2rem; }
    .step { display: none; }
    .step.active { display: block; }
    .question-card { background: #fff; border: 1px solid #ddd; border-radius: 6px; padding: 1rem; margin-bottom: 1rem; }
    .sticky-top-bar { position: sticky; top: 0; background: #fff; padding: 1rem; border-bottom: 1px solid #eee; z-index: 100; }
    .pagination { justify-content: center; }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="mb-4">পরীক্ষা নির্মাতা</h2>

    <!-- Step 1 -->
    <div class="step active" id="step1">
      <div class="mb-3">
        <label class="form-label">পরীক্ষার নাম</label>
        <input type="text" id="examName" class="form-control" required/>
      </div>
      <div class="mb-3">
        <label class="form-label">সময় (মিনিট)</label>
        <input type="number" id="examTime" class="form-control" required/>
      </div>
      <div class="mb-3">
        <label class="form-label">নেগেটিভ মার্কিং (প্রতি ভুল উত্তরে)</label>
        <input type="number" id="negativeMarking" class="form-control" step="0.01" value="0" required/>
      </div>
      <button class="btn btn-primary" onclick="goToStep(2)">পরবর্তী ধাপ</button>
    </div>

    <!-- Step 2 -->
    <div class="step" id="step2">
      <h4>বিষয় নির্বাচন করুন</h4>
      <div id="subjectList" class="mb-3"></div>
      <button class="btn btn-secondary" onclick="goToStep(1)">আগের ধাপ</button>
      <button class="btn btn-primary" onclick="goToStep(3)">পরবর্তী ধাপ</button>
    </div>

    <!-- Step 3 -->
    <div class="step" id="step3">
      <div class="sticky-top-bar d-flex justify-content-between align-items-center">
        <span>সিলেক্ট করা প্রশ্ন: <strong id="selectedCount">0</strong></span>
        <div>
          <button class="btn btn-sm btn-outline-primary" onclick="goToStep(2)">
            আরেকটি বিষয় সিলেক্ট করুন
          </button>
          <button class="btn btn-sm btn-outline-success" onclick="promptChapterSelection()">
            আরেকটি অধ্যায় সিলেক্ট করুন
          </button>
        </div>
      </div>

      <div id="chapterSelectArea" class="my-3"></div>
      <div id="questionArea"></div>
      <nav><ul class="pagination" id="pagination"></ul></nav>
      <button class="btn btn-success mt-3" onclick="createExamLink()">
        পরীক্ষা তৈরি করুন
      </button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <script>
    // উদাহরণ: এই অবজেক্টটি তোমার subject ও chapter অনুযায়ী ঠিক করে দাও
    const subjects = {
      "Botany": ["Chapter 01: কোষ ও এর গঠন", "Chapter 02: কোষ বিভাজন", "Chapter 03: কোষ রসায়ন", "Chapter 04: অণুজীব"],
      "Zoology": ["Chapter 01: প্রাণীর বিভিন্নতা ও শ্রেণিবিন্যাস", "Chapter 02: প্রাণীর পরিচিতি"]
      // ... অন্যান্য subject
    };

    let selectedQuestions = JSON.parse(localStorage.getItem("selectedQuestions") || "[]");
    let currentQuestions = [];
    const perPage = 20;
    let currentPage = 1;
    let currentSubject = "";
    let currentChapter = "";

    document.getElementById("selectedCount").textContent = selectedQuestions.length;

    function goToStep(n) {
      document.querySelectorAll(".step").forEach(s => s.classList.remove("active"));
      document.getElementById("step"+n).classList.add("active");
      if(n===2) populateSubjects();
    }

    function populateSubjects() {
      const list = document.getElementById("subjectList");
      list.innerHTML = "";
      Object.keys(subjects).forEach(sub => {
        const btn = document.createElement("button");
        btn.className = "btn btn-outline-primary m-1";
        btn.textContent = sub;
        btn.onclick = ()=> selectSubject(sub);
        list.appendChild(btn);
      });
    }

    function selectSubject(sub) {
      currentSubject = sub;
      const area = document.getElementById("chapterSelectArea");
      area.innerHTML = `<h5>${sub} - অধ্যায় নির্বাচন করুন</h5>`;
      subjects[sub].forEach(ch => {
        const btn = document.createElement("button");
        btn.className = "btn btn-outline-secondary m-1";
        btn.textContent = ch;
        btn.onclick = ()=> loadQuestions(sub, ch);
        area.appendChild(btn);
      });
      goToStep(3);
    }

    function promptChapterSelection() {
      goToStep(2);
    }

    function sanitizeFileName(name) {
      // স্পেস ও কোলন, টাইপ ছোট-বড় হাতের বাংলা ইংরেজি অক্ষর রেখে অন্যসব রিমুভ
      return name.replace(/^Chapter\s*\d+:\s*/, "")
                 .trim()
                 .replace(/\s+/g, "-")
                 .replace(/[^\u0980-\u09FFa-zA-Z0-9\-]/g, "");
    }

    async function loadQuestions(subject, chapter) {
      currentSubject = subject;
      currentChapter = chapter;
      currentPage = 1;
      const sub = sanitizeFileName(subject);
      const chap = sanitizeFileName(chapter);
      const path = `questions/subjects/${sub}/${chap}.json`;
      try {
        const res = await fetch(path);
        if(!res.ok) throw new Error(res.status+" "+res.statusText);
        const data = await res.json();
        // প্রত্যেক প্রশ্নে unique id লাগলে এখানে সেট করতে পারো, অথবা JSON-এ id রাখো
        currentQuestions = data.map((q,i)=>({
          id: q.id || `${sub}-${chap}-${i}`,
          question: q.question || `প্রশ্ন ${i+1}`,
          answer: q.answer || q.correctOption || ""
        }));
        renderQuestions();
      } catch(err) {
        console.error(err);
        Toastify({ text: "JSON লোড করতে ত্রুটি: "+err.message, duration:3000, style:{background:"#dc3545"} }).showToast();
      }
    }

    function renderQuestions() {
      const area = document.getElementById("questionArea");
      area.innerHTML = "";
      const start = (currentPage-1)*perPage;
      const pageItems = currentQuestions.slice(start, start+perPage);
      pageItems.forEach(q=>{
        const div = document.createElement("div");
        div.className = "question-card";
        div.innerHTML = `
          <div class="fw-bold">${q.question}</div>
          <div class="small text-muted">উত্তর: ${q.answer}</div>
          <div class="form-check mt-2">
            <input class="form-check-input" type="checkbox" id="${q.id}"
                   ${selectedQuestions.includes(q.id)?"checked":""}
                   onchange="toggleQuestion('${q.id}', this.checked)">
            <label class="form-check-label" for="${q.id}">নির্বাচন করুন</label>
          </div>`;
        area.appendChild(div);
      });
      renderPagination();
      document.getElementById("selectedCount").textContent = selectedQuestions.length;
    }

    function toggleQuestion(id, checked) {
      if(checked) {
        if(!selectedQuestions.includes(id)) selectedQuestions.push(id);
      } else {
        selectedQuestions = selectedQuestions.filter(x=>x!==id);
      }
      localStorage.setItem("selectedQuestions", JSON.stringify(selectedQuestions));
      document.getElementById("selectedCount").textContent = selectedQuestions.length;
    }

    function renderPagination() {
      const total = Math.ceil(currentQuestions.length/perPage);
      const ul = document.getElementById("pagination");
      ul.innerHTML = "";
      for(let i=1;i<=total;i++){
        const li = document.createElement("li");
        li.className = "page-item"+(i===currentPage?" active":"");
        li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
        li.onclick = e=>{
          e.preventDefault();
          currentPage=i;
          renderQuestions();
        };
        ul.appendChild(li);
      }
    }

    function createExamLink() {
      const id = Date.now();
      const payload = {
        name: document.getElementById("examName").value,
        time: parseInt(document.getElementById("examTime").value),
        negative: parseFloat(document.getElementById("negativeMarking").value),
        questions: selectedQuestions
      };
      localStorage.setItem("exam_"+id, JSON.stringify(payload));
      const link = `quiz.html?examId=${id}`;
      navigator.clipboard.writeText(window.location.origin+"/"+link);
      Toastify({ text: "লিংক কপি হয়েছে: "+link, duration:3000, style:{background:"#22c55e"} }).showToast();
    }
  </script>
</body>
</html>
