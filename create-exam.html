<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>পরীক্ষা নির্মাতা</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" rel="stylesheet"/>
  <style>
    body { font-family: 'Hind Siliguri', sans-serif; background: #f5f5f5; padding: 2rem; }
    .step { display: none; }
    .step.active { display: block; }
    .question-card { background: #fff; border: 1px solid #ddd; border-radius: 6px; padding: 1rem; margin-bottom: 1rem; }
    .sticky-top-bar { position: sticky; top: 0; background: #fff; padding: 1rem; border-bottom: 1px solid #eee; z-index: 100; }
    .pagination { justify-content: center; }
    #authStatus { position: fixed; top: 1rem; right: 1rem; }
  </style>
</head>
<body>
  <div id="authStatus" class="text-end">
    <span id="userEmail">অজানা ব্যবহারকারী</span>
    <button id="btnSignIn" class="btn btn-sm btn-outline-primary">লগইন</button>
    <button id="btnSignOut" class="btn btn-sm btn-outline-danger" style="display:none">লগআউট</button>
  </div>

  <div class="container">
    <h2 class="mb-4">পরীক্ষা নির্মাতা</h2>

    <!-- Step 1 -->
    <div class="step active" id="step1">
      <div class="mb-3">
        <label class="form-label">পরীক্ষার নাম</label>
        <input type="text" id="examName" class="form-control" required/>
      </div>
      <div class="mb-3">
        <label class="form-label">সময় (মিনিট)</label>
        <input type="number" id="examTime" class="form-control" required/>
      </div>
      <div class="mb-3">
        <label class="form-label">নেগেটিভ মার্কিং (প্রতি ভুল উত্তরে)</label>
        <input type="number" id="negativeMarking" class="form-control" step="0.01" value="0" required/>
      </div>
      <button class="btn btn-primary" onclick="goToStep(2)">পরবর্তী ধাপ</button>
    </div>

    <!-- Step 2 -->
    <div class="step" id="step2">
      <h4>বিষয় নির্বাচন করুন</h4>
      <div id="subjectList" class="mb-3"></div>
      <button class="btn btn-secondary" onclick="goToStep(1)">আগের ধাপ</button>
      <button class="btn btn-primary" onclick="goToStep(3)">পরবর্তী ধাপ</button>
    </div>

    <!-- Step 3 -->
    <div class="step" id="step3">
      <div class="sticky-top-bar d-flex justify-content-between align-items-center">
        <span>সিলেক্ট করা প্রশ্ন: <strong id="selectedCount">0</strong></span>
        <div>
          <button class="btn btn-sm btn-outline-primary" onclick="goToStep(2)">আরেকটি বিষয়</button>
          <button class="btn btn-sm btn-outline-success" onclick="promptChapterSelection()">আরেকটি অধ্যায়</button>
        </div>
      </div>
      <div id="chapterSelectArea" class="my-3"></div>
      <div id="questionArea"></div>
      <nav><ul class="pagination" id="pagination"></ul></nav>
      <button id="btnCreateExam" class="btn btn-success mt-3" onclick="createExam()">পরীক্ষা তৈরি করুন</button>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <script>
    // init Firebase
    const firebaseConfig = { /* তোমার config */ };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Auth UI
    const btnSignIn  = document.getElementById("btnSignIn");
    const btnSignOut = document.getElementById("btnSignOut");
    const userEmail  = document.getElementById("userEmail");
    const btnCreate  = document.getElementById("btnCreateExam");

    auth.onAuthStateChanged(user => {
      if (user) {
        userEmail.textContent = user.email || "Anonymous";
        btnSignIn.style.display  = "none";
        btnSignOut.style.display = "inline-block";
        btnCreate.disabled = false;
      } else {
        userEmail.textContent = "অজানা ব্যবহারকারী";
        btnSignIn.style.display  = "inline-block";
        btnSignOut.style.display = "none";
        btnCreate.disabled = true;
      }
    });
    btnSignIn.onclick  = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(console.error);
    btnSignOut.onclick = () => auth.signOut();

    // Dashboard subjects (all)
    const subjects = {
      "Botany": [/* … all chapters … */],
      "Zoology": [/* … */],
      "Physics 1st": [/* … */],
      "Physics 2nd": [/* … */],
      "Chemistry 1st": [/* … */],
      "Chemistry 2nd": [/* … */],
      "Higher Math 1st": [/* … */],
      "Higher Math 2nd": [/* … */],
      "English": [],
      "Bangla": []
    };

    let selectedQ = JSON.parse(localStorage.getItem("selectedQuestions")||"[]");
    let currentQ = [], perPage=20, page=1, curSub="", curChap="";

    document.getElementById("selectedCount").textContent = selectedQ.length;

    function goToStep(n){
      document.querySelectorAll(".step").forEach(s=>s.classList.remove("active"));
      document.getElementById("step"+n).classList.add("active");
      if(n===2) populateSubjects();
    }

    function populateSubjects(){
      const el = document.getElementById("subjectList");
      el.innerHTML="";
      Object.keys(subjects).forEach(sub=>{
        const btn=document.createElement("button");
        btn.className="btn btn-outline-primary m-1";
        btn.textContent=sub;
        btn.onclick=()=>selectSubject(sub);
        el.appendChild(btn);
      });
    }

    function selectSubject(sub){
      curSub=sub; page=1;
      const area=document.getElementById("chapterSelectArea");
      area.innerHTML=`<h5>${sub} - অধ্যায়</h5>`;
      subjects[sub].forEach(ch=>{
        const btn=document.createElement("button");
        btn.className="btn btn-outline-secondary m-1";
        btn.textContent=ch;
        btn.onclick=()=>loadQuestions(sub,ch);
        area.appendChild(btn);
      });
      goToStep(3);
    }

    function promptChapterSelection(){ goToStep(2); }

    function sanitizeFileName(name){
      return name.replace(/^Chapter\s*\d+:\s*/,"")
                 .trim().replace(/\s+/g,"-")
                 .replace(/[^\u0980-\u09FFa-zA-Z0-9\-]/g,"");
    }

    async function loadQuestions(sub, ch){
      curSub=sub; curChap=ch; page=1;
      const s=sanitizeFileName(sub), c=sanitizeFileName(ch);
      const url=`questions/subjects/${s}/${c}.json`;
      try {
        const r=await fetch(url);
        if(!r.ok) throw new Error(r.statusText);
        const data=await r.json();
        currentQ=data.map((q,i)=>({
          subject: sub,
          chapter: ch, // keep full chapter text
          id: i,
          question: q.question,
          options: q.options,
          correctOption: q.correctOption
        }));
        renderQuestions();
      } catch(e){
        Toastify({ text:"লোড এরর: "+e.message, duration:3000, style:{background:"#dc3545"} }).showToast();
      }
    }

    function renderQuestions(){
      const area=document.getElementById("questionArea");
      area.innerHTML="";
      const start=(page-1)*perPage;
      currentQ.slice(start,start+perPage).forEach(q=>{
        const key=`${q.subject}|${q.chapter}|${q.id}`;
        const div=document.createElement("div");
        div.className="question-card";
        div.innerHTML=`
          <div><strong>${q.question}</strong></div>
          <div class="small">উত্তর: ${q.options[q.correctOption-1]||""}</div>
          <div class="form-check mt-2">
            <input class="form-check-input" type="checkbox" id="${key}"
                   ${selectedQ.includes(key)?"checked":""}
                   onchange="toggleQ('${key}',this.checked)">
            <label class="form-check-label" for="${key}">নির্বাচন</label>
          </div>`;
        area.appendChild(div);
      });
      renderPagination();
      document.getElementById("selectedCount").textContent = selectedQ.length;
    }

    function toggleQ(key, ok){
      if(ok) {
        if(!selectedQ.includes(key)) selectedQ.push(key);
      } else {
        selectedQ = selectedQ.filter(x=>x!==key);
      }
      localStorage.setItem("selectedQuestions",JSON.stringify(selectedQ));
      document.getElementById("selectedCount").textContent = selectedQ.length;
    }

    function renderPagination(){
      const total = Math.ceil(currentQ.length / perPage);
      const ul = document.getElementById("pagination");
      ul.innerHTML="";
      for(let i=1;i<=total;i++){
        const li=document.createElement("li");
        li.className="page-item"+(i===page?" active":"");
        li.innerHTML=`<a class="page-link" href="#">${i}</a>`;
        li.onclick=e=>{ e.preventDefault(); page=i; renderQuestions(); };
        ul.appendChild(li);
      }
    }

    async function createExam(){
      if(!auth.currentUser) {
        return Toastify({ text:"প্রথমে লগইন করুন", duration:3000, style:{background:"#dc3545"} }).showToast();
      }

      // validation
      const title       = document.getElementById("examName").value.trim();
      const duration    = parseInt(document.getElementById("examTime").value,10);
      const negativeMark= parseFloat(document.getElementById("negativeMarking").value);
      if(!title || isNaN(duration) || duration<=0 || isNaN(negativeMark) || negativeMark<0 || selectedQ.length===0){
        return Toastify({ text:"সব ফিল্ড সঠিকভাবে পূরণ করুন", duration:3000, style:{background:"#dc3545"} }).showToast();
      }

      // build questions array
      const questions = selectedQ.map(key=>{
        const [sub,chap,id] = key.split("|");
        return { subject: sub, chapter: chap, id: parseInt(id,10) };
      });

      const payload = {
        title, duration, negativeMark, questions,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      try {
        await db.collection("exams").add(payload);
        // clear selections
        localStorage.removeItem("selectedQuestions");
        selectedQ = [];
        document.getElementById("selectedCount").textContent = "0";

        Toastify({ text:"পরীক্ষা সফলভাবে তৈরি হয়েছে", duration:3000, style:{background:"#22c55e"} }).showToast();
      } catch(err){
        console.error(err);
        Toastify({ text:"ত্রুটি: "+err.message, duration:3000, style:{background:"#dc3545"} }).showToast();
      }
    }
  </script>
</body>
</html>
