<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Sign Up / Log In</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .container { max-width: 400px; margin: auto; }
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; }
    input[type="email"], input[type="password"] {
      width: 100%; padding: 8px; box-sizing: border-box;
    }
    button { padding: 10px 20px; }
    #loginLink, #signupLink { cursor: pointer; color: blue; text-decoration: underline; }
    #message { color: red; margin-top: 10px; }
  </style>
  <!-- Firebase SDKs -->
  <!-- Firebase App (Core SDK) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <!-- Firebase Auth -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <!-- We will also initialize Cloud Messaging here, if you want to request notifications upon login -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-messaging-compat.js"></script>
</head>
<body>
  <div class="container">
    <h2 id="formTitle">Sign Up</h2>
    <div class="form-group">
      <label for="email">Email</label>
      <input type="email" id="email" placeholder="Enter your email" />
    </div>
    <div class="form-group">
      <label for="password">Password</label>
      <input type="password" id="password" placeholder="Enter your password" />
    </div>
    <button id="submitBtn">Sign Up</button>
    <p id="toggleText">
      Already have an account? <span id="loginLink">Log in</span>
    </p>
    <div id="message"></div>
  </div>

  <script>
    /*******************************
     * 1. Firebase Config & Init   *
     *******************************/
    const firebaseConfig = {
      apiKey: "AIzaSyBXXaWWoFqn6MpH6IWSm6CGaqUJzAmzbzA",
      authDomain: "dopamine-quiz.firebaseapp.com",
      projectId: "dopamine-quiz",
      storageBucket: "dopamine-quiz.firebasestorage.app",
      messagingSenderId: "822531459966",
      appId: "1:822531459966:web:8e7d2385090e997eb1c12f"
    };
    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const messaging = firebase.messaging();

    /*************************************************
     * 2. UI Logic for Switching Between Sign Up/Login
     *************************************************/
    const formTitle = document.getElementById('formTitle');
    const submitBtn = document.getElementById('submitBtn');
    const toggleText = document.getElementById('toggleText');
    const loginLink = document.getElementById('loginLink');
    const message = document.getElementById('message');
    let isSignUp = true;

    function switchToLogin() {
      isSignUp = false;
      formTitle.textContent = "Log In";
      submitBtn.textContent = "Log In";
      toggleText.innerHTML = `Don't have an account? <span id="signupLink">Sign up</span>`;
      attachLinkListener(); // reattach link events
    }

    function switchToSignUp() {
      isSignUp = true;
      formTitle.textContent = "Sign Up";
      submitBtn.textContent = "Sign Up";
      toggleText.innerHTML = `Already have an account? <span id="loginLink">Log in</span>`;
      attachLinkListener();
    }

    function attachLinkListener() {
      document.getElementById('loginLink')?.addEventListener('click', switchToLogin);
      document.getElementById('signupLink')?.addEventListener('click', switchToSignUp);
    }

    attachLinkListener();

    /********************************************
     * 3. Sign Up / Login with Firebase Auth
     ********************************************/
    submitBtn.addEventListener('click', async () => {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      message.textContent = "";
      message.style.color = "red";

      try {
        if (isSignUp) {
          // Sign Up
          await auth.createUserWithEmailAndPassword(email, password);
          message.style.color = "green";
          message.textContent = "Sign Up successful! You can now log in.";
          switchToLogin();
        } else {
          // Log In
          await auth.signInWithEmailAndPassword(email, password);
          message.style.color = "green";
          message.textContent = "Login successful! Redirecting...";
          
          // Request permission for notifications (optional, you can do this later)
          try {
            await messaging.requestPermission();
            const token = await messaging.getToken();
            console.log("FCM Token:", token);
            // You could store this token in Firestore if you want to send user-specific notifications
          } catch (notifErr) {
            console.warn("Notification permission not granted:", notifErr);
          }

          // Redirect to quiz or admin page
          window.location.href = "quiz.html";
        }
      } catch (error) {
        message.textContent = error.message;
      }
    });
  </script>
</body>
</html>
