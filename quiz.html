<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Biology MCQ Quiz</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    /* Sticky Timer at Top Left */
    #timer {
      position: fixed;
      top: 10px; left: 10px;
      z-index: 1000;
      background-color: #fff;
      padding: 5px 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-weight: bold;
    }
    /* Chapter Name Centered */
    #chapterName {
      text-align: center;
      margin-top: 40px; 
      font-size: 1.8em; font-weight: bold;
    }
    /* Question styling */
    .question {
      margin-bottom: 20px; padding: 10px;
      border: 1px solid #ddd; border-radius: 5px;
    }
    .question p { margin: 0 0 10px; }
    label {
      display: block; margin-bottom: 5px; padding: 5px; border-radius: 3px;
    }
    .correct { background-color: #c8e6c9; }
    .incorrect { background-color: #ffcdd2; }
    /* Submit Button Centered */
    #submitContainer { text-align: center; margin: 20px 0; }
    #submitBtn { padding: 10px 20px; font-size: 1em; }
    /* Result Containers */
    #scoreContainer {
      font-size: 1.4em; font-weight: bold;
      text-align: center; margin: 20px 0;
    }
    #solutionsContainer { margin-top: 20px; }
  </style>
  <!-- Firebase App (Core SDK) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <!-- Firebase Auth & Firestore -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <!-- Sticky Timer -->
  <div id="timer">Time left: 60 seconds</div>
  
  <!-- Chapter Name -->
  <div id="chapterName">Biology 1st Paper (Cell Division)</div>
  
  <!-- Exam Form Container -->
  <form id="examForm"></form>
  
  <!-- Submit Button Centered -->
  <div id="submitContainer">
    <button type="button" id="submitBtn">Submit</button>
  </div>
  
  <!-- Score and Solutions -->
  <div id="scoreContainer"></div>
  <div id="solutionsContainer"></div>
  
  <script>
    /*******************************
     * 1. Firebase Config & Init   *
     *******************************/
    const firebaseConfig = {
      apiKey: "AIzaSyBXXaWWoFqn6MpH6IWSm6CGaqUJzAmzbzA",
      authDomain: "dopamine-quiz.firebaseapp.com",
      projectId: "dopamine-quiz",
      storageBucket: "dopamine-quiz.firebasestorage.app",
      messagingSenderId: "822531459966",
      appId: "1:822531459966:web:8e7d2385090e997eb1c12f"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    /****************************************
     * 2. Ensure User is Logged In
     ****************************************/
    auth.onAuthStateChanged((user) => {
      if (!user) {
        // If not logged in, redirect to login page
        window.location.href = "auth.html";
      }
    });

    /****************************************
     * 3. Fetch Questions and Render Quiz
     ****************************************/
    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    db.collection("questions").orderBy("timestamp").get()
      .then((querySnapshot) => {
        let allQuestions = [];
        querySnapshot.forEach((doc) => {
          allQuestions.push(doc.data());
        });
        // If more than 50 questions, randomly select 50
        let selectedQuestions = allQuestions.length > 50 
          ? shuffleArray(allQuestions.slice()).slice(0, 50)
          : allQuestions;
        
        renderQuiz(selectedQuestions);
      })
      .catch((error) => {
        console.error("Error getting questions: ", error);
      });

    function renderQuiz(questions) {
      const examForm = document.getElementById('examForm');
      questions.forEach((q, index) => {
        const questionDiv = document.createElement('div');
        questionDiv.className = 'question';
        questionDiv.dataset.answer = q.answer;
    
        const questionText = document.createElement('p');
        questionText.textContent = (index + 1) + ". " + q.question;
        questionDiv.appendChild(questionText);
    
        let optionKeys = Object.keys(q.options);
        shuffleArray(optionKeys);
        optionKeys.forEach(key => {
          const label = document.createElement('label');
          const radioInput = document.createElement('input');
          radioInput.type = 'radio';
          radioInput.name = 'q' + index;
          radioInput.value = key;
          label.appendChild(radioInput);
          label.appendChild(document.createTextNode(" " + q.options[key]));
          questionDiv.appendChild(label);
        });
    
        examForm.appendChild(questionDiv);
      });
      
      startTimer();
    }

    /****************************************
     * 4. Timer Functionality
     ****************************************/
    let timeLeft = 60; 
    let timerRef;
    function startTimer() {
      const timerElement = document.getElementById('timer');
      timerRef = setInterval(() => {
        if (timeLeft <= 0) {
          clearInterval(timerRef);
          submitExam();
        } else {
          timerElement.textContent = "Time left: " + timeLeft + " seconds";
        }
        timeLeft--;
      }, 1000);
    }

    /****************************************
     * 5. Submit and Score
     ****************************************/
    document.getElementById('submitBtn').addEventListener('click', () => {
      submitExam();
    });

    function submitExam() {
      clearInterval(timerRef);
      let score = 0;
      const questionDivs = document.querySelectorAll('.question');
      
      questionDivs.forEach(q => {
        const correctAnswer = q.dataset.answer;
        const selectedOption = q.querySelector('input[type="radio"]:checked');
        if (selectedOption) {
          if (selectedOption.value === correctAnswer) {
            score += 1;
            selectedOption.parentElement.classList.add('correct');
          } else {
            score -= 1;
            selectedOption.parentElement.classList.add('incorrect');
            // Highlight the correct answer
            q.querySelectorAll('label').forEach(label => {
              if (label.querySelector('input').value === correctAnswer) {
                label.classList.add('correct');
              }
            });
          }
        } else {
          // If no answer is selected, highlight the correct answer
          q.querySelectorAll('label').forEach(label => {
            if (label.querySelector('input').value === correctAnswer) {
              label.classList.add('correct');
            }
          });
        }
      });

      // Display score
      document.getElementById('scoreContainer').textContent = "Your Score: " + score;
      // Show solutions
      document.getElementById('solutionsContainer').innerHTML = "<h3>Solutions:</h3>" + document.getElementById('examForm').innerHTML;
      document.getElementById('examForm').style.display = 'none';
      document.getElementById('submitContainer').style.display = 'none';

      // Save result to Firestore
      const user = auth.currentUser;
      if (user) {
        db.collection("scores").add({
          userId: user.uid,
          score: score,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        })
        .then(() => {
          console.log("Score saved!");
        })
        .catch((err) => console.error("Error saving score: ", err));
      }
    }
  </script>
</body>
</html>
