<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Exam</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    /* Header: Exam Name on left, Timer on right */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    #examNameDisplay {
      font-size: 1.8rem;
      font-weight: bold;
    }
    #timer {
      background: #fff;
      padding: 5px 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-weight: bold;
    }
    h2 { text-align: center; }
    .question { margin-bottom: 20px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
    .question p { margin: 0 0 10px; }
    label { display: block; margin-bottom: 5px; padding: 5px; border-radius: 3px; }
    .correct { background-color: #c8e6c9; }
    .incorrect { background-color: #ffcdd2; }
    #submitContainer { text-align: center; margin: 20px 0; }
    #submitBtn { padding: 10px 20px; font-size: 1em; }
    #scoreContainer { font-size: 1.4em; font-weight: bold; text-align: center; margin: 20px 0; }
    #solutionsContainer { margin-top: 20px; }
    .result { font-size: 1.2rem; font-weight: bold; }
    .result.correct { color: green; }
    .result.wrong { color: red; }
    .expired { text-align: center; color: red; font-size: 1.5rem; }
  </style>
  <!-- Firebase SDKs (compat versions) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <!-- Header: Exam Name and Timer -->
  <div class="header">
    <div id="examNameDisplay">Loading...</div>
    <div id="timer">--:--</div>
  </div>
  <h2>Exam</h2>
  <form id="examForm"></form>
  <div id="submitContainer">
    <button type="button" id="submitBtn" onclick="submitExam()">Submit</button>
  </div>
  <div id="scoreContainer"></div>
  <div id="solutionsContainer"></div>
  
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBXXaWWoFqn6MpH6IWSm6CGaqUJzAmzbzA",
      authDomain: "dopamine-quiz.firebaseapp.com",
      projectId: "dopamine-quiz",
      storageBucket: "dopamine-quiz.firebasestorage.app",
      messagingSenderId: "822531459966",
      appId: "1:822531459966:web:8e7d2385090e997eb1c12f"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Global exam parameters
    let examParams = {
      examName: "Untitled Exam",
      timer: 1, // in minutes
      marksPerQuestion: 1,
      negativeMark: 1,
      lastDate: null
    };

    // LocalStorage keys unique to this exam
    const urlParams = new URLSearchParams(window.location.search);
    const examId = urlParams.get("examId");
    const startTimeKey = "examStartTime_" + (examId || "default");
    const answersKey = "examAnswers_" + (examId || "default");

    let savedAnswers = JSON.parse(localStorage.getItem(answersKey)) || {};
    let submitted = false;
    let timerRef;

    // Check if exam is expired
    function isExamExpired(lastDate) {
      if (!lastDate) return false;
      const examDeadline = new Date(lastDate);
      return new Date() > examDeadline;
    }

    // Render quiz questions
    function renderQuiz(questions) {
      const examForm = document.getElementById("examForm");
      examForm.innerHTML = "";
      questions.forEach((q, index) => {
        const questionDiv = document.createElement("div");
        questionDiv.className = "question";
        questionDiv.dataset.answer = q.correctOption;
        const questionText = document.createElement("p");
        questionText.textContent = `${index + 1}. ${q.question}`;
        questionDiv.appendChild(questionText);
        q.options.forEach((opt, idx) => {
          const label = document.createElement("label");
          const radioInput = document.createElement("input");
          radioInput.type = "radio";
          radioInput.name = "q" + index;
          radioInput.value = String(idx + 1);
          if (savedAnswers["q" + index] === radioInput.value) {
            radioInput.checked = true;
          }
          radioInput.addEventListener("change", () => {
            savedAnswers["q" + index] = radioInput.value;
            localStorage.setItem(answersKey, JSON.stringify(savedAnswers));
          });
          label.appendChild(radioInput);
          label.appendChild(document.createTextNode(` ${opt}`));
          questionDiv.appendChild(label);
        });
        examForm.appendChild(questionDiv);
      });
      startTimer();
    }

    // Start timer
    function startTimer() {
      const timerElement = document.getElementById("timer");
      let storedStart = localStorage.getItem(startTimeKey);
      if (!storedStart) {
        storedStart = Date.now();
        localStorage.setItem(startTimeKey, storedStart);
      } else {
        storedStart = parseInt(storedStart, 10);
      }
      const examDurationMs = examParams.timer * 60 * 1000;
      let remainingMs = examDurationMs - (Date.now() - storedStart);
      if (remainingMs < 0) remainingMs = 0;
      let timeLeft = Math.floor(remainingMs / 1000);

      timerRef = setInterval(() => {
        if (timeLeft <= 0) {
          clearInterval(timerRef);
          if (!submitted) submitExam();
        } else {
          const minutes = Math.floor(timeLeft / 60);
          const seconds = timeLeft % 60;
          timerElement.textContent = `${minutes.toString().padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
          timeLeft--;
        }
      }, 1000);
    }

    // Load default questions
    function loadDefaultQuestions() {
      db.collection("questions").orderBy("timestamp", "desc").limit(50).get()
        .then(querySnapshot => {
          const questions = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          renderQuiz(questions);
        })
        .catch(error => {
          console.error("Error retrieving questions:", error);
          document.getElementById("examForm").innerHTML = "<p>Error retrieving questions.</p>";
        });
    }

    // Authentication and exam loading
    auth.onAuthStateChanged(user => {
      if (!user) {
        window.location.href = 'auth.html';
      } else {
        if (examId) {
          db.collection("examResults").where("userId", "==", user.uid).where("examId", "==", examId).get()
            .then(querySnapshot => {
              if (!querySnapshot.empty) {
                document.body.innerHTML = "<div class='expired'>You have already taken this exam.</div>";
              } else {
                db.collection("exams").doc(examId).get()
                  .then(doc => {
                    if (doc.exists) {
                      const examData = doc.data();
                      examParams.examName = examData.examName || examParams.examName;
                      examParams.timer = examData.timer || examParams.timer;
                      examParams.marksPerQuestion = examData.marksPerQuestion || examParams.marksPerQuestion;
                      examParams.negativeMark = examData.negativeMark || examParams.negativeMark;
                      examParams.lastDate = examData.lastDate || null;
                      document.getElementById("examNameDisplay").innerText = examParams.examName;
                      if (isExamExpired(examParams.lastDate)) {
                        document.body.innerHTML = "<div class='expired'>This exam is expired. You cannot participate.</div>";
                        return;
                      }
                      const questionIds = examData.questions || [];
                      if (questionIds.length === 0) {
                        document.getElementById("examForm").innerHTML = "<p>No questions selected for this exam.</p>";
                        return;
                      }
                      if (questionIds.length <= 10) {
                        db.collection("questions").where(firebase.firestore.FieldPath.documentId(), "in", questionIds).get()
                          .then(querySnapshot => {
                            const questions = querySnapshot.docs.map(qdoc => ({ id: qdoc.id, ...qdoc.data() }));
                            renderQuiz(questions);
                          })
                          .catch(error => {
                            console.error("Error loading exam questions:", error);
                            document.getElementById("examForm").innerHTML = "<p>Error loading exam questions.</p>";
                          });
                      } else {
                        Promise.all(questionIds.map(qid => db.collection("questions").doc(qid).get()))
                          .then(docs => {
                            const questions = docs.filter(doc => doc.exists).map(doc => ({ id: doc.id, ...doc.data() }));
                            renderQuiz(questions);
                          })
                          .catch(error => {
                            console.error("Error loading exam questions:", error);
                            document.getElementById("examForm").innerHTML = "<p>Error loading exam questions.</p>";
                          });
                      }
                    } else {
                      console.error("Exam not found.");
                      loadDefaultQuestions();
                    }
                  })
                  .catch(error => {
                    console.error("Error retrieving exam:", error);
                    loadDefaultQuestions();
                  });
              }
            })
            .catch(error => {
              console.error("Error checking exam result:", error);
            });
        } else {
          loadDefaultQuestions();
        }
      }
    });

    // Submit exam
    function submitExam() {
      if (submitted) return;
      submitted = true;
      clearInterval(timerRef);
      let score = 0;
      let correctCount = 0;
      let wrongCount = 0;
      const questionDivs = document.querySelectorAll(".question");

      questionDivs.forEach(q => {
        const correctAnswer = q.dataset.answer;
        const selectedOption = q.querySelector("input[type='radio']:checked");
        if (selectedOption) {
          if (selectedOption.value === correctAnswer) {
            score += examParams.marksPerQuestion;
            correctCount++;
            selectedOption.parentElement.classList.add("correct");
          } else {
            score -= examParams.negativeMark;
            wrongCount++;
            selectedOption.parentElement.classList.add("incorrect");
            q.querySelectorAll("label").forEach(label => {
              if (label.querySelector("input").value === correctAnswer) label.classList.add("correct");
            });
          }
        } else {
          wrongCount++;
          q.querySelectorAll("label").forEach(label => {
            if (label.querySelector("input").value === correctAnswer) label.classList.add("correct");
          });
        }
      });

      document.getElementById("scoreContainer").innerHTML = `Your Score: ${score.toFixed(2)}`;
      const resultsHTML = `
        <p class="result correct">Correct Answers: ${correctCount}</p>
        <p class="result wrong">Wrong Answers: ${wrongCount}</p>
      `;
      document.getElementById("solutionsContainer").innerHTML = resultsHTML + "<h3>Solutions:</h3>" + document.getElementById("examForm").innerHTML;
      document.getElementById("examForm").style.display = "none";
      document.getElementById("submitContainer").style.display = "none";

      // Record exam result
      if (examId) {
        const userId = auth.currentUser.uid;
        db.collection("examResults").add({
          userId: userId,
          examId: examId,
          score: score,
          correctCount: correctCount,
          wrongCount: wrongCount,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
          console.log("Exam result recorded.");
        }).catch(error => {
          console.error("Error recording exam result:", error);
        });
      }

      localStorage.removeItem(startTimeKey);
      localStorage.removeItem(answersKey);
    }
  </script>
</body>
</html>
