<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dopamine Quiz - Exam</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #timer { position: fixed; top: 10px; left: 10px; background: #fff; padding: 5px 10px; border: 1px solid #ddd; border-radius: 5px; font-weight: bold; }
    #examNameDisplay { text-align: center; font-size: 1.8rem; margin-bottom: 20px; }
    h2 { text-align: center; }
    .question { margin-bottom: 20px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
    .question p { margin: 0 0 10px; }
    label { display: block; margin-bottom: 5px; padding: 5px; border-radius: 3px; }
    .correct { background-color: #c8e6c9; }
    .incorrect { background-color: #ffcdd2; }
    #submitContainer { text-align: center; margin: 20px 0; }
    #submitBtn { padding: 10px 20px; font-size: 1em; }
    #scoreContainer { font-size: 1.4em; font-weight: bold; text-align: center; margin: 20px 0; }
    #solutionsContainer { margin-top: 20px; }
    .result { font-size: 1.2rem; font-weight: bold; }
    .result.correct { color: green; }
    .result.wrong { color: red; }
  </style>
  <!-- Firebase SDKs (compat versions) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <!-- Timer Display -->
  <div id="timer">Time left: -- seconds</div>
  <!-- Exam Name Display -->
  <div id="examNameDisplay">Exam: Loading...</div>
  <!-- Quiz Heading -->
  <h2>Dopamine Quiz</h2>
  <!-- Quiz Form -->
  <form id="examForm"></form>
  <!-- Submit Button -->
  <div id="submitContainer">
    <button type="button" id="submitBtn">Submit</button>
  </div>
  <!-- Score and Results -->
  <div id="scoreContainer"></div>
  <div id="solutionsContainer"></div>
  
  <script>
    // Firebase configuration using your provided details
    const firebaseConfig = {
      apiKey: "AIzaSyBXXaWWoFqn6MpH6IWSm6CGaqUJzAmzbzA",
      authDomain: "dopamine-quiz.firebaseapp.com",
      projectId: "dopamine-quiz",
      storageBucket: "dopamine-quiz.firebasestorage.app",
      messagingSenderId: "822531459966",
      appId: "1:822531459966:web:8e7d2385090e997eb1c12f"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Global exam parameters (default values; will be updated if examId exists)
    let examParams = {
      examName: "Untitled Exam",
      timer: 1, // in minutes
      marksPerQuestion: 1,
      negativeMark: 1
    };

    // Utility: Get query parameters
    const urlParams = new URLSearchParams(window.location.search);
    const examId = urlParams.get("examId");

    // Use localStorage keys unique to this exam (or default)
    const startTimeKey = "examStartTime_" + (examId || "default");
    const answersKey = "examAnswers_" + (examId || "default");

    // Retrieve previously saved answers (if any)
    let savedAnswers = {};
    try {
      savedAnswers = JSON.parse(localStorage.getItem(answersKey)) || {};
    } catch (e) {
      savedAnswers = {};
    }

    // Function to render quiz questions on the page
    function renderQuiz(questions) {
      const examForm = document.getElementById("examForm");
      examForm.innerHTML = ""; // clear previous content
      questions.forEach((q, index) => {
        const questionDiv = document.createElement("div");
        questionDiv.className = "question";
        // Store correct answer in data attribute (as string: "1", "2", etc.)
        questionDiv.dataset.answer = q.correctOption;
        // Create question text element
        const questionText = document.createElement("p");
        questionText.textContent = (index + 1) + ". " + q.question;
        questionDiv.appendChild(questionText);
        // Create answer options (assumes options is an array of 4 strings)
        q.options.forEach((opt, idx) => {
          const label = document.createElement("label");
          const radioInput = document.createElement("input");
          radioInput.type = "radio";
          radioInput.name = "q" + index;
          radioInput.value = String(idx + 1); // Options numbered as "1", "2", etc.
          // Restore saved answer if exists
          if (savedAnswers["q" + index] === radioInput.value) {
            radioInput.checked = true;
          }
          // When an answer is selected, update localStorage
          radioInput.addEventListener("change", () => {
            savedAnswers["q" + index] = radioInput.value;
            localStorage.setItem(answersKey, JSON.stringify(savedAnswers));
          });
          label.appendChild(radioInput);
          label.appendChild(document.createTextNode(" " + opt));
          questionDiv.appendChild(label);
        });
        examForm.appendChild(questionDiv);
      });
      // Start timer using examParams.timer (if not already started)
      startTimer();
    }
    
    // Timer functionality: use examParams.timer (in minutes) and persist start time
    let timeLeft; // in seconds
    let timerRef;
    function startTimer() {
      const timerElement = document.getElementById("timer");
      // Check if start time exists in localStorage
      let storedStart = localStorage.getItem(startTimeKey);
      if (!storedStart) {
        storedStart = Date.now();
        localStorage.setItem(startTimeKey, storedStart);
      } else {
        storedStart = parseInt(storedStart, 10);
      }
      // Calculate exam duration in ms
      const examDurationMs = examParams.timer * 60 * 1000;
      // Calculate remaining time (ms)
      const elapsed = Date.now() - storedStart;
      let remainingMs = examDurationMs - elapsed;
      if (remainingMs < 0) { remainingMs = 0; }
      // Convert to seconds
      timeLeft = Math.floor(remainingMs / 1000);
      
      timerRef = setInterval(() => {
        if (timeLeft <= 0) {
          clearInterval(timerRef);
          submitExam();
        } else {
          timerElement.textContent = "Time left: " + timeLeft + " seconds";
        }
        timeLeft--;
      }, 1000);
    }
    
    // Function to load default questions (if no examId is provided)
    function loadDefaultQuestions() {
      db.collection("questions").orderBy("timestamp", "desc").limit(50).get()
        .then(querySnapshot => {
          let questions = [];
          querySnapshot.forEach(doc => {
            let data = doc.data();
            data.id = doc.id;
            questions.push(data);
          });
          renderQuiz(questions);
        })
        .catch(error => {
          console.error("Error retrieving questions: ", error);
          document.getElementById("examForm").innerHTML = "<p>Error retrieving questions.</p>";
        });
    }
    
    // Load exam questions if examId exists, else fallback to default
    if (examId) {
      db.collection("exams").doc(examId).get()
        .then(doc => {
          if (doc.exists) {
            const examData = doc.data();
            // Update global exam parameters if available
            examParams.examName = examData.examName || examParams.examName;
            examParams.timer = examData.timer || examParams.timer;
            examParams.marksPerQuestion = examData.marksPerQuestion || examParams.marksPerQuestion;
            examParams.negativeMark = examData.negativeMark || examParams.negativeMark;
            // Display exam name at the top
            document.getElementById("examNameDisplay").innerText = "Exam: " + examParams.examName;
            const selectedQuestionIds = examData.questions || [];
            if (selectedQuestionIds.length === 0) {
              document.getElementById("examForm").innerHTML = "<p>No questions selected for this exam.</p>";
              return;
            }
            // For 10 or fewer questions, use "in" query; else fetch individually
            if (selectedQuestionIds.length <= 10) {
              db.collection("questions")
                .where(firebase.firestore.FieldPath.documentId(), "in", selectedQuestionIds)
                .get()
                .then(querySnapshot => {
                  let questions = [];
                  querySnapshot.forEach(qdoc => {
                    let data = qdoc.data();
                    data.id = qdoc.id;
                    questions.push(data);
                  });
                  renderQuiz(questions);
                })
                .catch(error => {
                  console.error("Error loading exam questions: ", error);
                  document.getElementById("examForm").innerHTML = "<p>Error loading exam questions.</p>";
                });
            } else {
              Promise.all(selectedQuestionIds.map(qid => db.collection("questions").doc(qid).get()))
                .then(docs => {
                  let questions = [];
                  docs.forEach(doc => {
                    if (doc.exists) {
                      let data = doc.data();
                      data.id = doc.id;
                      questions.push(data);
                    }
                  });
                  renderQuiz(questions);
                })
                .catch(error => {
                  console.error("Error loading exam questions: ", error);
                  document.getElementById("examForm").innerHTML = "<p>Error loading exam questions.</p>";
                });
            }
          } else {
            console.error("Exam not found.");
            loadDefaultQuestions();
          }
        })
        .catch(error => {
          console.error("Error retrieving exam: ", error);
          loadDefaultQuestions();
        });
    } else {
      loadDefaultQuestions();
    }
    
    // Submit exam: calculate score, count correct and wrong answers, and display results
    document.getElementById("submitBtn").addEventListener("click", () => {
      clearInterval(timerRef);
      let score = 0;
      let correctCount = 0;
      let wrongCount = 0;
      const questionDivs = document.querySelectorAll(".question");
      
      questionDivs.forEach(q => {
        const correctAnswer = q.dataset.answer;
        const selectedOption = q.querySelector("input[type='radio']:checked");
        if (selectedOption) {
          if (selectedOption.value === correctAnswer) {
            score += examParams.marksPerQuestion;
            correctCount++;
            selectedOption.parentElement.classList.add("correct");
          } else {
            score -= examParams.negativeMark;
            wrongCount++;
            selectedOption.parentElement.classList.add("incorrect");
            // Highlight the correct answer
            q.querySelectorAll("label").forEach(label => {
              if (label.querySelector("input").value === correctAnswer) {
                label.classList.add("correct");
              }
            });
          }
        } else {
          wrongCount++;
          q.querySelectorAll("label").forEach(label => {
            if (label.querySelector("input").value === correctAnswer) {
              label.classList.add("correct");
            }
          });
        }
      });
      
      const scoreContainer = document.getElementById("scoreContainer");
      scoreContainer.innerHTML = "Your Score: " + score.toFixed(2);
      
      const resultsHTML = `
        <p class="result correct">Correct Answers: ${correctCount}</p>
        <p class="result wrong">Wrong Answers: ${wrongCount}</p>
      `;
      const solutionsContainer = document.getElementById("solutionsContainer");
      solutionsContainer.innerHTML = "<h3>Solutions:</h3>" + document.getElementById("examForm").innerHTML + resultsHTML;
      document.getElementById("examForm").style.display = "none";
      document.getElementById("submitContainer").style.display = "none";
      
      // Optionally, clear stored exam state after submission
      localStorage.removeItem(startTimeKey);
      localStorage.removeItem(answersKey);
    });
  </script>
</body>
</html>
