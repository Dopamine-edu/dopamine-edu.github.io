<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Existing head content remains the same -->
  <style>
    /* Add new styles for stats header */
    .stats-header {
      background: #fff;
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .stats-header div {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <!-- Existing body content remains same until solutionsContainer -->
  <div class="container">
    <div class="header">
      <div id="examNameDisplay">Loading...</div>
      <div id="timer">--:--</div>
    </div>
    <div id="statsHeader" class="stats-header" style="display: none;">
      <div>
        <span id="scoreDisplay" class="fw-bold"></span>
        <span id="statsCount"></span>
      </div>
    </div>
    <!-- Rest of container content remains same -->
  </div>

  <script>
    // Update renderQuiz function for one-time selection
    function renderQuiz(questions, isReview = false, previousAnswers = {}) {
      allQuestions = questions;
      const examForm = document.getElementById("examForm");
      examForm.innerHTML = "";

      questions.forEach((q, idx) => {
        const questionDiv = document.createElement("div");
        questionDiv.className = "question-card";
        questionDiv.dataset.answer = q.correctOption;
        questionDiv.innerHTML = `<p class="fw-bold mb-3">${idx + 1}. ${q.question}</p>`;
        
        const hasExistingAnswer = savedAnswers["q" + idx] !== undefined;
        
        q.options.forEach((opt, optIdx) => {
          const label = document.createElement("label");
          const radioInput = document.createElement("input");
          radioInput.type = "radio";
          radioInput.name = "q" + idx;
          radioInput.value = String(optIdx + 1);
          
          if (isReview || hasExistingAnswer) {
            radioInput.disabled = true;
          }

          if (isReview) {
            // Review mode handling (existing logic)
          } else {
            if (savedAnswers["q" + idx] === radioInput.value) {
              radioInput.checked = true;
              // Disable all radios in this question
              questionDiv.querySelectorAll('input[type="radio"]').forEach(input => {
                input.disabled = true;
              });
            }
            
            radioInput.addEventListener("change", () => {
              savedAnswers["q" + idx] = radioInput.value;
              localStorage.setItem(answersKey, JSON.stringify(savedAnswers));
              // Disable all radios in this question
              questionDiv.querySelectorAll('input[type="radio"]').forEach(input => {
                input.disabled = true;
              });
            });
          }
          
          label.appendChild(radioInput);
          label.appendChild(document.createTextNode(" " + opt));
          questionDiv.appendChild(label);
        });
        
        examForm.appendChild(questionDiv);
      });

      if (!isReview && !timerRef) startTimer();
    }

    // Update submitExam function for stats header
    function submitExam() {
      if (submitted) return;
      submitted = true;
      clearInterval(timerRef);
      localStorage.removeItem(startTimeKey);

      let score = 0;
      let correctCount = 0;
      let wrongCount = 0;
      const totalQuestions = allQuestions.length;

      // Existing scoring logic...

      // Update stats header
      document.getElementById("statsHeader").style.display = "block";
      document.getElementById("scoreDisplay").innerHTML = 
        `Score: <span class="text-primary">${score.toFixed(2)}</span>/<span>${totalQuestions}</span>`;
      document.getElementById("statsCount").innerHTML = 
        `<span class="text-success">✓ ${correctCount}</span> 
         <span class="text-danger">✗ ${wrongCount}</span>`;

      // Existing solution display logic...
    }

    // Update authStateChanged callback to check localStorage submission
    auth.onAuthStateChanged((user) => {
      // Existing checks...
      
      if (examId && localStorage.getItem('examSubmitted_' + examId)) {
        showExamExpired("You have already submitted this exam");
        return;
      }

      // Rest of existing logic...
    });

    // Add helper function for exam expiration
    function showExamExpired(message) {
      document.getElementById("expiredMessage").style.display = "block";
      document.getElementById("expiredMessage").innerText = message;
      document.getElementById("examForm").style.display = "none";
      document.getElementById("submitContainer").style.display = "none";
      document.getElementById("timer").style.display = "none";
    }

    // Update startTimer to handle submission persistence
    function startTimer() {
      const timerElement = document.getElementById("timer");
      let storedStart = localStorage.getItem(startTimeKey);
      
      if (!storedStart) {
        storedStart = Date.now();
        localStorage.setItem(startTimeKey, storedStart);
      } else {
        storedStart = parseInt(storedStart, 10);
      }

      const examDurationMs = examParams.timer * 60 * 1000;
      let remainingMs = examDurationMs - (Date.now() - storedStart);
      
      if (remainingMs <= 0) {
        submitExam();
        return;
      }

      // Existing timer logic...
    }

    // Update submitExam to set submission flag
    function submitExam() {
      // Existing submission logic...
      
      if (examId) {
        localStorage.setItem('examSubmitted_' + examId, 'true');
        // Firestore submission logic...
      }
    }
  </script>
</body>
</html> 
