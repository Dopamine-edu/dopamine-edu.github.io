<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ডোপামিন - Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap');

        :root {
            --bg-color: #f8f9fd;
            --text-color: #2c3e50;
            --card-bg: #ffffff;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            --border-color: #e0e6ed;
            --primary-color: #4f46e5;
            --hover-color: #4338ca;
            --secondary-text-color: #64748b;
            --glow-color: rgba(79, 70, 229, 0.2);
            --subject-card-bg: #eef2ff;
            --settings-card-bg: #fff7ed;
            --custom-exam-bg: #f0f5ff;
            --gradient-primary: linear-gradient(135deg, #4f46e5, #6366f1);
            --gradient-hover: linear-gradient(135deg, #4338ca, #4f46e5);
        }

        [data-theme="dark"] {
            --bg-color: #111827;
            --text-color: #f1f5f9;
            --card-bg: #1f2937;
            --shadow: 0 4px 20px rgba(255, 255, 255, 0.05);
            --border-color: #374151;
            --secondary-text-color: #94a3b8;
            --glow-color: rgba(99, 102, 241, 0.2);
            --subject-card-bg: #312e81;
            --settings-card-bg: #431407;
            --custom-exam-bg: #1e1b4b;
            --gradient-primary: linear-gradient(135deg, #6366f1, #4f46e5);
            --gradient-hover: linear-gradient(135deg, #4f46e5, #4338ca);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Hind Siliguri', sans-serif;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }

        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background: var(--bg-color);
            color: var(--text-color);
            padding: 1rem;
        }

        .navbar {
            background: var(--card-bg);
            padding: 1rem 2rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 1rem;
            z-index: 1000;
            margin: 0 auto;
            max-width: 1400px;
            width: calc(100% - 2rem);
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .nav-left img {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            box-shadow: 0 2px 8px var(--glow-color);
        }

        .website-name {
            font-size: 1.6rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .login-btn {
            background: var(--gradient-primary);
            color: white;
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px var(--glow-color);
        }

        .login-btn:hover {
            background: var(--gradient-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--glow-color);
        }

        .theme-toggle {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 1.4rem;
            padding: 0.5rem;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            transform: rotate(15deg) scale(1.1);
            color: var(--hover-color);
        }

        .menu-container {
            position: relative;
        }

        .menu-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 1.4rem;
            padding: 0.5rem;
            transition: all 0.3s ease;
        }

        .menu-btn:hover {
            transform: scale(1.1);
            color: var(--hover-color);
        }

        .menu-dropdown {
            position: absolute;
            right: 0;
            top: 3.5rem;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow);
            display: none;
            min-width: 240px;
            z-index: 1000;
            overflow: hidden;
        }

        .menu-dropdown.show {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-info {
            text-align: center;
            padding: 1.5rem 1rem;
            border-bottom: 1px solid var(--border-color);
            background: var(--gradient-primary);
            color: white;
        }

        .user-avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            margin: 0 auto;
            cursor: pointer;
            overflow: hidden;
            border: 3px solid white;
            box-shadow: 0 0 12px rgba(255,255,255,0.3);
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-name {
            margin-top: 0.75rem;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
        }

        .menu-item {
            padding: 1rem 1.5rem;
            color: var(--text-color);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s ease;
        }

        .menu-item:hover {
            background: var(--border-color);
            padding-left: 2rem;
            color: var(--primary-color);
        }

        .greeting-section {
            padding: 3rem 2rem;
            text-align: center;
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: var(--shadow);
            margin: 2rem auto 1.5rem;
            max-width: 1400px;
        }

        .greeting {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 0.75rem;
        }

        .sub-greeting {
            font-size: 1.1rem;
            color: var(--secondary-text-color);
        }

        .cards-container {
            flex: 1;
            padding: 1rem 2rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: var(--shadow);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 140px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--gradient-primary);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 8px 24px var(--glow-color);
        }

        .card:hover::before {
            opacity: 0.05;
        }

        .card-icon {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
            transition: transform 0.3s ease;
        }

        .card:hover .card-icon {
            transform: scale(1.1);
        }

        .card-title {
            color: var(--text-color);
            font-size: 1rem;
            font-weight: 600;
            z-index: 1;
        }

        .card.glowing {
            box-shadow: 0 0 12px var(--glow-color);
            animation: pulseGlow 2s ease-in-out infinite;
        }

        @keyframes pulseGlow {
            0% { box-shadow: 0 0 8px var(--glow-color); }
            50% { box-shadow: 0 0 16px var(--glow-color); }
            100% { box-shadow: 0 0 8px var(--glow-color); }
        }

        .custom-exam-section {
            padding: 2rem;
            max-width: 1400px;
            margin: 2rem auto;
            background: var(--custom-exam-bg);
            border-radius: 20px;
            box-shadow: var(--shadow);
            position: relative;
        }

        .custom-exam-headline {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .custom-exam-card {
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .custom-exam-card:hover {
            box-shadow: 0 8px 24px var(--glow-color);
        }

        .subject-card {
            background: var(--subject-card-bg);
            border-left: 6px solid var(--primary-color);
        }

        .settings-card {
            background: var(--settings-card-bg);
            border-left: 6px solid #f59e0b;
        }

        @media (min-width: 768px) {
            .settings-card {
                position: sticky;
                top: 2rem;
                align-self: flex-start;
            }
        }

        .custom-exam-card-title {
            font-size: 1.6rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--border-color);
            display: inline-block;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .settings-card .custom-exam-card-title {
            background: linear-gradient(135deg, #f59e0b, #ef4444);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .form-label {
            display: block;
            margin-bottom: 0.75rem;
            font-weight: 600;
            color: var(--text-color);
        }

        .form-control {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            color: var(--text-color);
            width: 100%;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 8px var(--glow-color);
            outline: none;
        }

        .select-wrapper {
            position: relative;
        }

        .select-wrapper::after {
            content: "▼";
            font-size: 1rem;
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: var(--secondary-text-color);
        }

        select.form-control {
            appearance: none;
            padding-right: 2.5rem;
        }

        .custom-time-input {
            display: none;
            margin-top: 0.75rem;
        }

        .summary-section {
            background: rgba(79, 70, 229, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 2rem 0;
        }

        [data-theme="dark"] .summary-section {
            background: rgba(99, 102, 241, 0.1);
        }

        .summary-title {
            font-weight: 700;
            margin-bottom: 0.75rem;
            color: var(--primary-color);
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .summary-label {
            color: var(--secondary-text-color);
        }

        .summary-value {
            font-weight: 600;
            color: var(--text-color);
        }

        .btn-primary {
            background: var(--gradient-primary);
            border: none;
            color: #fff;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            font-size: 1.1rem;
            font-weight: 600;
            box-shadow: 0 2px 8px var(--glow-color);
        }

        .btn-primary:hover {
            background: var(--gradient-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--glow-color);
        }

        .btn-primary:disabled {
            background: #a5b4fc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .subject-box {
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 1rem;
            background: var(--card-bg);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .subject-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .subject-header:hover {
            background: var(--border-color);
        }

        .subject-header .form-check-input {
            margin-right: 0.75rem;
            width: 22px;
            height: 22px;
            border: 2px solid var(--border-color);
            cursor: pointer;
            border-radius: 4px;
        }

        .subject-header .form-check-input:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .subject-name {
            flex-grow: 1;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .question-count {
            color: #fff;
            background: var(--primary-color);
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.95rem;
        }

        [data-theme="dark"] .question-count {
            background: #6366f1;
        }

        .arrow {
            cursor: pointer;
            color: var(--primary-color);
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }

        .arrow.active {
            transform: rotate(180deg);
        }

        .chapter-list {
            max-height: 0;
            overflow: hidden;
            padding: 0;
            transition: max-height 0.5s ease-in-out, padding 0.3s ease;
        }

        .chapter-list.show {
            max-height: 600px;
            padding: 0.75rem 0 0.75rem 2.5rem;
        }

        .chapter-box {
            display: flex;
            align-items: center;
            padding: 0.75rem 0;
            justify-content: space-between;
            transition: background 0.3s ease;
        }

        .chapter-box:hover {
            background: var(--border-color);
        }

        .chapter-box .form-check-input {
            margin-right: 0.75rem;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            cursor: pointer;
            border-radius: 4px;
        }

        .chapter-box .form-check-input:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .chapter-name {
            flex-grow: 1;
            font-size: 1rem;
        }

        .chapter-question-count {
            color: #fff;
            background: #f59e0b;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.95rem;
        }

        [data-theme="dark"] .chapter-question-count {
            background: #fbbf24;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 3rem;
            color: var(--primary-color);
            font-size: 1.4rem;
            animation: spin 1s linear infinite;
        }

        .loading-spinner::before {
            content: "\f110";
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            margin-right: 0.75rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -1rem;
        }

        .col-md-6 {
            padding: 0 1rem;
            flex: 0 0 100%;
            max-width: 100%;
        }

        @media (min-width: 768px) {
            .col-md-6 {
                flex: 0 0 50%;
                max-width: 50%;
            }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            overflow-y: auto;
        }

        .modal-content {
            background-color: var(--card-bg);
            margin: 5% auto;
            padding: 2rem;
            border-radius: 20px;
            width: 90%;
            max-width: 800px;
            box-shadow: var(--shadow);
            position: relative;
        }

        .close-modal {
            position: absolute;
            top: 1rem;
            right: 1.5rem;
            font-size: 2rem;
            font-weight: bold;
            color: var(--secondary-text-color);
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-modal:hover {
            color: var(--primary-color);
        }

        .tab-btn {
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            margin: 0 0.5rem 1rem 0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            background: var(--gradient-hover);
            box-shadow: 0 2px 8px var(--glow-color);
        }

        .tab-content {
            display: none;
            padding: 1.5rem 0;
        }

        .tab-content.active {
            display: block;
        }

        #friendList {
            margin-top: 1rem;
        }

        .friend-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .friend-item:hover {
            background-color: rgba(79, 70, 229, 0.1);
        }

        .friend-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            margin-right: 1rem;
            box-shadow: 0 2px 8px var(--glow-color);
        }

        #battleScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-color);
            z-index: 1000;
            padding: 2rem;
            display: none;
            overflow-y: auto;
        }

        .player-info {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-bottom: 2.5rem;
        }

        .player {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }

        .player .avatar {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            border: 4px solid var(--primary-color);
            object-fit: cover;
            box-shadow: 0 4px 16px var(--glow-color);
        }

        .player .name {
            margin-top: 0.75rem;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .player .score {
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-top: 0.5rem;
        }

        .vs {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
            margin: 0 1.5rem;
        }

        .question-container {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 16px;
            max-width: 900px;
            margin: 0 auto;
            box-shadow: var(--shadow);
        }

        .timer {
            font-size: 2rem;
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            font-weight: 700;
        }

        .question-text {
            font-size: 1.2rem;
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        .options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .option {
            padding: 1rem;
            background: var(--subject-card-bg);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            text-align: left;
            box-shadow: var(--shadow);
        }

        .option:hover {
            background: var(--gradient-primary);
            color: white;
            transform: translateY(-2px);
        }

        .option.correct {
            background: #22c55e;
            color: white;
        }

        .option.incorrect {
            background: #ef4444;
            color: white;
        }

        .battle-result {
            text-align: center;
            margin-top: 2.5rem;
        }

        .battle-result h2 {
            font-size: 2.2rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .battle-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 1.5rem;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 1rem;
            color: var(--secondary-text-color);
        }

        #matchmakingStatus {
            text-align: center;
            margin-top: 1rem;
            font-style: italic;
            color: var(--secondary-text-color);
        }

        .history-item {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            transition: background 0.3s ease;
        }

        .history-item.win {
            background-color: rgba(34, 197, 94, 0.1);
        }

        .history-item.lose {
            background-color: rgba(239, 68, 68, 0.1);
        }

        .history-opponent {
            display: flex;
            align-items: center;
        }

        .history-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            margin-right: 1rem;
        }

        @media (max-width: 767px) {
            .navbar {
                padding: 1rem;
                top: 0.5rem;
            }

            .nav-left img {
                width: 35px;
                height: 35px;
            }

            .website-name {
                font-size: 1.3rem;
            }

            .greeting-section {
                padding: 2rem 1rem;
                margin: 1rem auto 1rem;
            }

            .greeting {
                font-size: 1.6rem;
            }

            .sub-greeting {
                font-size: 1rem;
            }

            .cards-container {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
                padding: 0.5rem;
            }

            .card {
                padding: 1rem;
                min-height: 120px;
            }

            .card-icon {
                font-size: 2rem;
            }

            .card-title {
                font-size: 0.9rem;
            }

            .custom-exam-section {
                padding: 1.5rem;
                margin: 1rem auto;
            }

            .custom-exam-headline {
                font-size: 1.4rem;
            }

            .custom-exam-card {
                padding: 1.5rem;
            }

            .custom-exam-card-title {
                font-size: 1.4rem;
            }

            .options {
                grid-template-columns: 1fr;
            }

            .player .avatar {
                width: 70px;
                height: 70px;
            }

            .vs {
                font-size: 1.5rem;
                margin: 0 1rem;
            }
        }

        .modal-content {
            width: 95%;
            max-width: 900px;
            padding: 1.5rem;
        }

        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .tab-btn {
            padding: 0.75rem 1.25rem;
            font-size: 1rem;
        }

        .chart-container {
            position: relative;
            height: 350px;
            margin-bottom: 1.5rem;
            background: var(--card-bg);
            padding: 1rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .stats-summary {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .stat-label {
            font-weight: 600;
            color: var(--secondary-text-color);
        }

        .stat-value {
            font-weight: 700;
            color: var(--text-color);
        }

        .subject-stats, .chapter-stats, .timeline-stats {
            background: var(--card-bg);
            padding: 1rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-top: 1rem;
        }

        .subject-stats h5, .chapter-stats h5 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .progress {
            height: 12px;
            background-color: var(--border-color);
            margin-bottom: 1rem;
            border-radius: 6px;
            overflow: hidden;
        }

        .progress-bar {
            background: var(--gradient-primary);
            height: 100%;
            transition: width 0.3s ease;
        }

        .strength-meter {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            gap: 1rem;
        }

        .strength-label {
            width: 140px;
            font-weight: 600;
            font-size: 0.95rem;
        }

        @media (max-width: 768px) {
            .modal-content {
                padding: 1rem;
            }
            
            .tab-btn {
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
            }
            
            .chart-container {
                height: 250px;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div id="content">
        <nav class="navbar">
            <div class="nav-left">
                <img src="logo.png" alt="ডোপামিন Logo" onerror="this.src='https://via.placeholder.com/45';">
                <h1 class="website-name">ডোপামিন</h1>
            </div>
            <div class="nav-right" id="nav-right">
                <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
                    <i class="fas fa-moon" id="themeIcon"></i>
                </button>
                <div class="menu-container" id="menu-container">
                    <button class="menu-btn" onclick="toggleMenu(event)">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="menu-dropdown" id="menuDropdown">
                        <div class="user-info" onclick="requireLogin('https://dopamine-edu.github.io/profile.html')">
                            <div class="user-avatar">
                                <img id="userAvatar" src="https://cdn-icons-png.flaticon.com/512/4333/4333609.png" alt="User Avatar" onerror="this.src='https://via.placeholder.com/70';">
                            </div>
                            <div class="user-name" id="userFullName">ব্যবহারকারী</div>
                        </div>
                        <a href="https://dopamine-edu.github.io/courses.html" class="menu-item" onclick="return requireLogin('https://dopamine-edu.github.io/courses.html')">
                            <i class="fas fa-book"></i>
                            কোর্স
                        </a>
                        <a href="#" class="menu-item" onclick="return requireLogin('#')">
                            <i class="fab fa-facebook"></i>
                            ফেসবুক গ্রুপ
                        </a>
                        <a href="#" class="menu-item" onclick="return requireLogin('#')">
                            <i class="fab fa-telegram"></i>
                            টেলিগ্রাম গ্রুপ
                        </a>
                        <a href="#" class="menu-item" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i>
                            লগআউট
                        </a>
                    </div>
                </div>
                <a href="https://dopamine-edu.github.io/auth.html" class="login-btn" id="login-btn" style="display: none;">লগইন করুন</a>
            </div>
        </nav>

        <div class="greeting-section">
            <h1 class="greeting">হ্যালো, <span id="lastName">ব্যবহারকারী</span>!</h1>
            <p class="sub-greeting">কেমন চলছে আপনার পড়াশোনা? আজকের লক্ষ্য অর্জন করুন!</p>
        </div>

        <div class="cards-container">
            <div class="card" onclick="requireLogin('https://dopamine-edu.github.io/studyplanner.html')">
                <i class="fas fa-tasks card-icon"></i>
                <h3 class="card-title">স্টাডি প্ল্যানার</h3>
            </div>
            <div class="card glowing" onclick="requireLogin('https://dopamine-edu.github.io/eid-salami-exam.html')">
                <i class="fas fa-graduation-cap card-icon"></i>
                <h3 class="card-title">ঈদ সালামী এক্সাম</h3>
            </div>
            <div class="card" onclick="requireLogin('https://dopamine-edu.github.io/courses.html')">
                <i class="fas fa-book card-icon"></i>
                <h3 class="card-title">কোর্স</h3>
            </div>
            <div class="card glowing" onclick="scrollToCustomExam()">
                <i class="fas fa-cogs card-icon"></i>
                <h3 class="card-title">কাস্টম পরীক্ষা</h3>
            </div>
            <div class="card" onclick="window.location.href='https://t.me/PDF_paradise'">
                <i class="fas fa-file-pdf card-icon"></i>
                <h3 class="card-title">পিডিএফ</h3>
            </div>
            <div class="card glowing" onclick="openBattleModal()">
                <i class="fas fa-gamepad card-icon"></i>
                <h3 class="card-title">কুইজ ব্যাটল</h3>
            </div>
            <div class="card" onclick="showPerformanceModal()">
                <i class="fas fa-chart-line card-icon"></i>
                <h3 class="card-title">পারফরম্যান্স</h3>
            </div>
        </div>

        <!-- Performance Modal -->
        <div id="performanceModal" class="modal">
            <div class="modal-content">
                <span class="close-modal" onclick="closePerformanceModal()">×</span>
                <h2 class="text-center mb-4">আপনার পারফরম্যান্স বিশ্লেষণ</h2>
                
                <div class="tabs mb-3">
                    <button class="tab-btn active" onclick="openPerformanceTab('overall')">সামগ্রিক</button>
                    <button class="tab-btn" onclick="openPerformanceTab('subject')">বিষয়ভিত্তিক</button>
                    <button class="tab-btn" onclick="openPerformanceTab('chapter')">অধ্যায়ভিত্তিক</button>
                    <button class="tab-btn" onclick="openPerformanceTab('timeline')">সময়রেখা</button>
                </div>
                
                <div id="overall" class="tab-content active">
                    <div class="row">
                        <div class="col-md-6">
                            <h4 class="text-center mb-3">সামগ্রিক পারফরম্যান্স</h4>
                            <div class="chart-container">
                                <canvas id="overallChart"></canvas>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="stats-summary">
                                <h4 class="text-center mb-3">পরিসংখ্যান</h4>
                                <div class="stat-item">
                                    <span class="stat-label">পরীক্ষা দেওয়া হয়েছে:</span>
                                    <span class="stat-value" id="totalExams">0</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">সর্বোচ্চ স্কোর:</span>
                                    <span class="stat-value" id="highestScore">0</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">গড় স্কোর:</span>
                                    <span class="stat-value" id="averageScore">0</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">সঠিক উত্তরের হার:</span>
                                    <span class="stat-value" id="accuracyRate">0%</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">গড় সম্পূর্ণতা:</span>
                                    <span class="stat-value" id="completionRate">0%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="subject" class="tab-content">
                    <div class="row">
                        <div class="col-md-6">
                            <h4 class="text-center mb-3">বিষয়ভিত্তিক পারফরম্যান্স</h4>
                            <div class="chart-container">
                                <canvas id="subjectChart"></canvas>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="subject-selector">
                                <label for="subjectSelect" class="form-label">বিষয় নির্বাচন করুন:</label>
                                <select id="subjectSelect" class="form-control" onchange="updateSubjectStats()">
                                    <option value="">সব বিষয়</option>
                                </select>
                            </div>
                            <div class="subject-stats" id="subjectStats">
                                <!-- Will be populated dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="chapter" class="tab-content">
                    <div class="row">
                        <div class="col-md-4">
                            <label for="chapterSubjectSelect" class="form-label">বিষয় নির্বাচন করুন:</label>
                            <select id="chapterSubjectSelect" class="form-control" onchange="updateChapterList()">
                                <option value="">সব বিষয়</option>
                            </select>
                        </div>
                        <div class="col-md-8">
                            <div class="chapter-stats" id="chapterStats">
                                <!-- Will be populated dynamically -->
                            </div>
                        </div>
                    </div>
                    <div class="chart-container mt-3">
                        <canvas id="chapterChart"></canvas>
                    </div>
                </div>
                
                <div id="timeline" class="tab-content">
                    <div class="chart-container">
                        <canvas id="timelineChart"></canvas>
                    </div>
                    <div class="timeline-stats mt-3" id="timelineStats">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>
            </div>
        </div>

        <div class="custom-exam-section" id="custom-exam-section">
            <h2 class="custom-exam-headline">কাস্টম পরীক্ষা তৈরি করুন</h2>
            <div class="container">
                <div id="loading-spinner" class="loading-spinner">পরীক্ষা তৈরি হচ্ছে...</div>
                <form id="customExamForm">
                    <div class="row">
                        <div class="col-md-6 form-group">
                            <div class="custom-exam-card subject-card">
                                <h2 class="custom-exam-card-title">বিষয় নির্বাচন</h2>
                                <div id="subjectSelection"></div>
                            </div>
                        </div>
                        <div class="col-md-6 form-group">
                            <div class="custom-exam-card settings-card">
                                <h2 class="custom-exam-card-title">পরীক্ষা সেটিংস</h2>
                                <div class="settings-content">
                                    <div class="form-group">
                                        <label for="numQuestions" class="form-label">প্রশ্নের সংখ্যা</label>
                                        <input type="number" id="numQuestions" class="form-control" min="1" required placeholder="প্রশ্ন সংখ্যা লিখুন" />
                                    </div>
                                    <div class="form-group">
                                        <label for="timeSelect" class="form-label">সময় (মিনিট)</label>
                                        <div class="select-wrapper">
                                            <select id="timeSelect" class="form-control">
                                                <option value="10">১০ মিনিট</option>
                                                <option value="20">২০ মিনিট</option>
                                                <option value="30">৩০ মিনিট</option>
                                                <option value="60">৬০ মিনিট</option>
                                                <option value="custom">কাস্টম সময়</option>
                                            </select>
                                        </div>
                                        <div id="customTimeInput" class="custom-time-input">
                                            <input type="number" id="customTime" class="form-control" min="1" placeholder="কাস্টম মিনিট লিখুন" />
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="negativeMarking" class="form-label">নেগেটিভ মার্কিং (প্রতি ভুল উত্তরে)</label>
                                        <input type="number" id="negativeMarking" class="form-control" min="0" step="0.01" value="0" placeholder="০" />
                                    </div>
                                    <div class="summary-section">
                                        <div class="summary-title">সেটিংস সামারি</div>
                                        <div class="summary-item">
                                            <span class="summary-label">মোট প্রশ্ন:</span>
                                            <span id="summaryQuestions" class="summary-value">০</span>
                                        </div>
                                        <div class="summary-item">
                                            <span class="summary-label">সময়:</span>
                                            <span id="summaryTime" class="summary-value">০ মিনিট</span>
                                        </div>
                                        <div class="summary-item">
                                            <span class="summary-label">নেগেটিভ মার্কিং:</span>
                                            <span id="summaryNegative" class="summary-value">০</span>
                                        </div>
                                    </div>
                                    <button type="submit" class="btn-primary">পরীক্ষা শুরু</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="battleModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeBattleModal()">×</span>
            <h2>কুইজ ব্যাটল</h2>
            
            <div id="battleTabs">
                <button class="tab-btn active" onclick="openBattleTab('quickBattle')">দ্রুত খেলুন</button>
                <button class="tab-btn" onclick="openBattleTab('challengeFriend')">বন্ধুকে চ্যালেঞ্জ</button>
                <button class="tab-btn" onclick="openBattleTab('battleHistory')">ইতিহাস</button>
            </div>
            
            <div id="quickBattle" class="tab-content active">
                <p>একটি দ্রুত ম্যাচ খেলুন</p>
                <button class="btn-primary" onclick="findOpponent()">খেলোয়াড় খুঁজুন</button>
                <div id="matchmakingStatus"></div>
            </div>
            
            <div id="challengeFriend" class="tab-content">
                <input type="text" id="friendSearch" class="form-control" placeholder="বন্ধুর নাম লিখুন" oninput="searchFriends()">
                <div id="friendList"></div>
            </div>
            
            <div id="battleHistory" class="tab-content">
                <div id="historyList"></div>
            </div>
        </div>
    </div>

    <div id="battleScreen">
        <div class="player-info">
            <div class="player" id="player1">
                <img src="" class="avatar" id="player1Avatar">
                <span class="name" id="player1Name"></span>
                <span class="score" id="player1Score">0</span>
            </div>
            <div class="vs">VS</div>
            <div class="player" id="player2">
                <img src="" class="avatar" id="player2Avatar">
                <span class="name" id="player2Name"></span>
                <span class="score" id="player2Score">0</span>
            </div>
        </div>
        
        <div class="question-container">
            <div class="timer" id="questionTimer">30</div>
            <div class="question-text" id="battleQuestionText"></div>
            <div class="options" id="battleOptions">
                <button class="option" onclick="submitAnswer(0)"></button>
                <button class="option" onclick="submitAnswer(1)"></button>
                <button class="option" onclick="submitAnswer(2)"></button>
                <button class="option" onclick="submitAnswer(3)"></button>
            </div>
        </div>
        
        <div class="battle-result" id="battleResult" style="display: none;">
            <h2 id="resultTitle">আপনি জিতেছেন!</h2>
            <div class="battle-stats">
                <div class="stat-item">
                    <div class="stat-value" id="finalPlayer1Score">0</div>
                    <div class="stat-label">আপনার স্কোর</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="finalPlayer2Score">0</div>
                    <div class="stat-label">প্রতিপক্ষের স্কোর</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="correctAnswers">0</div>
                    <div class="stat-label">সঠিক উত্তর</div>
                </div>
            </div>
            <button class="btn-primary" onclick="closeBattleScreen()" style="margin-top: 20px;">ফিরে যান</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script>
    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyBXXaWWoFqn6MpH6IWSm6CGaqUJzAmzbzA",
        authDomain: "dopamine-quiz.firebaseapp.com",
        projectId: "dopamine-quiz",
        storageBucket: "dopamine-quiz.appspot.com",
        messagingSenderId: "822531459966",
        appId: "1:822531459966:web:8e7d2385090e997eb1c12f"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ==================== PERFORMANCE FEATURES ====================
    let performanceChartInstances = {};
    let performanceData = {};

    function showPerformanceModal() {
        if (!isAuthenticated) {
            Toastify({ text: "পারফরম্যান্স দেখতে লগইন করুন!", duration: 3000, style: { background: "#dc3545" } }).showToast();
            window.location.href = 'https://dopamine-edu.github.io/auth.html';
            return;
        }
        document.getElementById('performanceModal').style.display = 'block';
        loadPerformanceData();
    }

    function closePerformanceModal() {
        document.getElementById('performanceModal').style.display = 'none';
        Object.values(performanceChartInstances).forEach(chart => chart.destroy());
        performanceChartInstances = {};
    }

    function openPerformanceTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        document.querySelector(`[onclick="openPerformanceTab('${tabId}')"]`).classList.add('active');
        if (performanceData) renderPerformanceChart(tabId);
    }

    async function loadPerformanceData() {
        const loading = Toastify({ text: "পারফরম্যান্স ডেটা লোড হচ্ছে...", duration: -1, style: { background: "#6b48ff" } });
        loading.showToast();

        try {
            const userId = auth.currentUser.uid;
            const attemptsSnapshot = await db.collection('attempts')
                .where('userId', '==', userId)
                .orderBy('timestamp', 'desc')
                .limit(20)
                .get();

            performanceData = { 
                attempts: [], 
                subjects: {}, 
                chapters: {}, 
                timeline: [], 
                overall: {
                    totalExams: 0,
                    totalQuestions: 0,
                    correctAnswers: 0,
                    incorrectAnswers: 0,
                    skippedAnswers: 0,
                    highestScore: 0,
                    totalScore: 0
                }
            };

            const examIds = [...new Set(attemptsSnapshot.docs.map(doc => doc.data().examId))];
            const examsMap = {};
            
            // Batch process exams (10 at a time)
            for (let i = 0; i < examIds.length; i += 10) {
                const batch = examIds.slice(i, i + 10);
                const snapshot = await db.collection('exams')
                    .where(firebase.firestore.FieldPath.documentId(), 'in', batch)
                    .get();
                snapshot.forEach(doc => examsMap[doc.id] = doc.data());
            }

            attemptsSnapshot.forEach(doc => {
                const attempt = doc.data();
                const exam = examsMap[attempt.examId] || {};
                
                // Timeline data
                performanceData.timeline.push({
                    date: attempt.timestamp.toDate(),
                    score: attempt.score,
                    total: attempt.totalQuestions * (exam.marksPerQuestion || 1),
                    examTitle: exam.title || 'কাস্টম পরীক্ষা'
                });

                // Overall stats
                performanceData.overall.totalExams++;
                performanceData.overall.totalQuestions += attempt.totalQuestions;
                performanceData.overall.correctAnswers += attempt.correctAnswers;
                performanceData.overall.incorrectAnswers += attempt.incorrectAnswers;
                performanceData.overall.skippedAnswers += attempt.skippedAnswers;
                performanceData.overall.totalScore += attempt.score;
                
                if (attempt.score > performanceData.overall.highestScore) {
                    performanceData.overall.highestScore = attempt.score;
                }

                // Subject-wise data
                if (exam.subjects?.length > 0) {
                    exam.subjects.forEach(subject => {
                        if (!performanceData.subjects[subject]) {
                            performanceData.subjects[subject] = {
                                totalQuestions: 0,
                                correctAnswers: 0,
                                incorrectAnswers: 0,
                                skippedAnswers: 0,
                                attempts: 0
                            };
                        }
                        
                        const questionsPerSubject = Math.floor(attempt.totalQuestions / exam.subjects.length);
                        performanceData.subjects[subject].totalQuestions += questionsPerSubject;
                        performanceData.subjects[subject].correctAnswers += Math.floor(attempt.correctAnswers / exam.subjects.length);
                        performanceData.subjects[subject].incorrectAnswers += Math.floor(attempt.incorrectAnswers / exam.subjects.length);
                        performanceData.subjects[subject].skippedAnswers += Math.floor(attempt.skippedAnswers / exam.subjects.length);
                        performanceData.subjects[subject].attempts++;
                    });
                }

                // Chapter-wise data
                if (exam.chapters?.length > 0) {
                    exam.chapters.forEach(chapter => {
                        const chapterName = chapter.replace(/^Chapter \d+:\s*/, '');
                        const subject = exam.subjects?.find(s => chapter.includes(s)) || 'Unknown';
                        
                        if (!performanceData.chapters[chapterName]) {
                            performanceData.chapters[chapterName] = {
                                subject: subject,
                                totalQuestions: 0,
                                correctAnswers: 0,
                                incorrectAnswers: 0,
                                skippedAnswers: 0,
                                attempts: 0
                            };
                        }
                        
                        const questionsPerChapter = Math.floor(attempt.totalQuestions / exam.chapters.length);
                        performanceData.chapters[chapterName].totalQuestions += questionsPerChapter;
                        performanceData.chapters[chapterName].correctAnswers += Math.floor(attempt.correctAnswers / exam.chapters.length);
                        performanceData.chapters[chapterName].incorrectAnswers += Math.floor(attempt.incorrectAnswers / exam.chapters.length);
                        performanceData.chapters[chapterName].skippedAnswers += Math.floor(attempt.skippedAnswers / exam.chapters.length);
                        performanceData.chapters[chapterName].attempts++;
                    });
                }
            });

            updateOverallStats();
            populateSubjectDropdowns();
            renderPerformanceChart('overall');
            
        } catch (error) {
            console.error("Error loading performance data:", error);
            Toastify({ text: "ডেটা লোড করতে ত্রুটি: " + error.message, duration: 3000, style: { background: "#dc3545" } }).showToast();
        } finally {
            loading.hideToast();
        }
    }

    function updateOverallStats() {
        const overall = performanceData.overall;
        document.getElementById('totalExams').textContent = overall.totalExams;
        document.getElementById('highestScore').textContent = overall.highestScore;
        
        const averageScore = overall.totalExams > 0 
            ? (overall.totalScore / overall.totalExams).toFixed(1) 
            : 0;
        document.getElementById('averageScore').textContent = averageScore;
        
        const accuracyRate = overall.totalQuestions > 0 
            ? ((overall.correctAnswers / overall.totalQuestions) * 100).toFixed(1) + '%' 
            : '0%';
        document.getElementById('accuracyRate').textContent = accuracyRate;
        
        const completionRate = overall.totalQuestions > 0 
            ? (((overall.correctAnswers + overall.incorrectAnswers) / overall.totalQuestions) * 100).toFixed(1) + '%' 
            : '0%';
        document.getElementById('completionRate').textContent = completionRate;
    }

    function populateSubjectDropdowns() {
        const subjectSelect = document.getElementById('subjectSelect');
        const chapterSubjectSelect = document.getElementById('chapterSubjectSelect');
        
        subjectSelect.innerHTML = '<option value="">সব বিষয়</option>';
        chapterSubjectSelect.innerHTML = '<option value="">সব বিষয়</option>';
        
        Object.keys(performanceData.subjects).forEach(subject => {
            const option = document.createElement('option');
            option.value = subject;
            option.textContent = subject;
            subjectSelect.appendChild(option.cloneNode(true));
            chapterSubjectSelect.appendChild(option);
        });
        
        updateSubjectStats();
    }

    function updateSubjectStats() {
        const subjectSelect = document.getElementById('subjectSelect');
        const selectedSubject = subjectSelect.value;
        const subjectStatsDiv = document.getElementById('subjectStats');
        
        if (!selectedSubject) {
            const overall = performanceData.overall;
            subjectStatsDiv.innerHTML = `
                <h5>সব বিষয়ের সম্মিলিত পারফরম্যান্স</h5>
                <div class="strength-meter">
                    <span class="strength-label">সঠিক উত্তর:</span>
                    <div class="progress" style="flex-grow: 1;">
                        <div class="progress-bar" role="progressbar" 
                             style="width: ${(overall.correctAnswers / overall.totalQuestions) * 100}%; background-color: #28a745;">
                        </div>
                    </div>
                    <span class="ms-2">${overall.correctAnswers}/${overall.totalQuestions}</span>
                </div>
                <div class="strength-meter">
                    <span class="strength-label">ভুল উত্তর:</span>
                    <div class="progress" style="flex-grow: 1;">
                        <div class="progress-bar" role="progressbar" 
                             style="width: ${(overall.incorrectAnswers / overall.totalQuestions) * 100}%; background-color: #dc3545;">
                        </div>
                    </div>
                    <span class="ms-2">${overall.incorrectAnswers}/${overall.totalQuestions}</span>
                </div>
                <div class="strength-meter">
                    <span class="strength-label">এড়িয়ে যাওয়া:</span>
                    <div class="progress" style="flex-grow: 1;">
                        <div class="progress-bar" role="progressbar" 
                             style="width: ${(overall.skippedAnswers / overall.totalQuestions) * 100}%; background-color: #6c757d;">
                        </div>
                    </div>
                    <span class="ms-2">${overall.skippedAnswers}/${overall.totalQuestions}</span>
                </div>
            `;
        } else {
            const subject = performanceData.subjects[selectedSubject];
            subjectStatsDiv.innerHTML = `
                <h5>${selectedSubject} পারফরম্যান্স</h5>
                <p><strong>পরীক্ষা দেওয়া হয়েছে:</strong> ${subject.attempts}</p>
                <div class="strength-meter">
                    <span class="strength-label">সঠিক উত্তর:</span>
                    <div class="progress" style="flex-grow: 1;">
                        <div class="progress-bar" role="progressbar" 
                             style="width: ${(subject.correctAnswers / subject.totalQuestions) * 100}%; background-color: #28a745;">
                        </div>
                    </div>
                    <span class="ms-2">${subject.correctAnswers}/${subject.totalQuestions}</span>
                </div>
                <div class="strength-meter">
                    <span class="strength-label">ভুল উত্তর:</span>
                    <div class="progress" style="flex-grow: 1;">
                        <div class="progress-bar" role="progressbar" 
                             style="width: ${(subject.incorrectAnswers / subject.totalQuestions) * 100}%; background-color: #dc3545;">
                        </div>
                    </div>
                    <span class="ms-2">${subject.incorrectAnswers}/${subject.totalQuestions}</span>
                </div>
                <div class="strength-meter">
                    <span class="strength-label">এড়িয়ে যাওয়া:</span>
                    <div class="progress" style="flex-grow: 1;">
                        <div class="progress-bar" role="progressbar" 
                             style="width: ${(subject.skippedAnswers / subject.totalQuestions) * 100}%; background-color: #6c757d;">
                        </div>
                    </div>
                    <span class="ms-2">${subject.skippedAnswers}/${subject.totalQuestions}</span>
                </div>
            `;
        }
        renderPerformanceChart('subject');
    }

    function updateChapterList() {
        const subjectSelect = document.getElementById('chapterSubjectSelect');
        const selectedSubject = subjectSelect.value;
        const chapterStatsDiv = document.getElementById('chapterStats');
        
        const filteredChapters = Object.entries(performanceData.chapters)
            .filter(([_, data]) => !selectedSubject || data.subject === selectedSubject)
            .sort((a, b) => b[1].attempts - a[1].attempts);
        
        if (filteredChapters.length === 0) {
            chapterStatsDiv.innerHTML = '<p>কোনো অধ্যায়ের ডেটা পাওয়া যায়নি</p>';
            return;
        }
        
        let html = '<h5>অধ্যায়ভিত্তিক পারফরম্যান্স</h5><div class="row">';
        
        filteredChapters.forEach(([chapter, data]) => {
            const accuracy = data.totalQuestions > 0 
                ? (data.correctAnswers / data.totalQuestions * 100).toFixed(1) 
                : 0;
            
            html += `
                <div class="col-md-6 mb-3">
                    <div class="chapter-card p-3" style="background: var(--card-bg); border-radius: 8px; box-shadow: var(--shadow);">
                        <h6>${chapter}</h6>
                        <small class="text-muted">${data.subject}</small>
                        <div class="d-flex justify-content-between mt-2">
                            <span>সঠিকতা:</span>
                            <span class="fw-bold">${accuracy}%</span>
                        </div>
                        <div class="progress mt-1" style="height: 8px;">
                            <div class="progress-bar" role="progressbar" 
                                 style="width: ${accuracy}%; background-color: ${accuracy > 70 ? '#28a745' : accuracy > 40 ? '#ffc107' : '#dc3545'};">
                            </div>
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            <small>সঠিক: ${data.correctAnswers}</small>
                            <small>ভুল: ${data.incorrectAnswers}</small>
                            <small>এড়ানো: ${data.skippedAnswers}</small>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        chapterStatsDiv.innerHTML = html;
        renderPerformanceChart('chapter');
    }

    function renderPerformanceChart(tabId) {
        // Check if Chart is available
        if (typeof Chart === 'undefined') {
            console.error('Chart.js is not loaded');
            Toastify({ 
                text: "চার্ট প্রদর্শনের জন্য প্রয়োজনীয় লাইব্রেরি লোড হয়নি", 
                duration: 3000, 
                style: { background: "#dc3545" } 
            }).showToast();
            return;
        }
        if (performanceChartInstances[tabId]) {
            performanceChartInstances[tabId].destroy();
        }
        
        const ctx = document.getElementById(`${tabId}Chart`).getContext('2d');
        let chart;
        
        switch (tabId) {
            case 'overall':
                const overall = performanceData.overall;
                chart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['সঠিক উত্তর', 'ভুল উত্তর', 'এড়িয়ে যাওয়া'],
                        datasets: [{
                            data: [overall.correctAnswers, overall.incorrectAnswers, overall.skippedAnswers],
                            backgroundColor: ['#28a745', '#dc3545', '#6c757d'],
                            borderColor: '#fff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'bottom' },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const value = context.raw;
                                        const percentage = Math.round((value / total) * 100);
                                        return `${context.label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
                break;
                
            case 'subject':
                const subjectSelect = document.getElementById('subjectSelect');
                const selectedSubject = subjectSelect.value;
                
                if (!selectedSubject) {
                    const subjects = Object.keys(performanceData.subjects);
                    const accuracyData = subjects.map(subject => {
                        const s = performanceData.subjects[subject];
                        return s.totalQuestions > 0 
                            ? (s.correctAnswers / s.totalQuestions * 100) 
                            : 0;
                    });
                    
                    chart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: subjects,
                            datasets: [{
                                label: 'সঠিক উত্তরের হার (%)',
                                data: accuracyData,
                                backgroundColor: subjects.map((_, i) => 
                                    `hsl(${(i * 360 / subjects.length)}, 70%, 50%)`),
                                borderColor: '#fff',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    title: { display: true, text: 'সঠিক উত্তরের হার (%)' }
                                }
                            },
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const subject = performanceData.subjects[context.label];
                                            return [
                                                `সঠিক: ${subject.correctAnswers}/${subject.totalQuestions}`,
                                                `ভুল: ${subject.incorrectAnswers}`,
                                                `এড়ানো: ${subject.skippedAnswers}`
                                            ];
                                        }
                                    }
                                }
                            }
                        }
                    });
                } else {
                    const subject = performanceData.subjects[selectedSubject];
                    chart = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: ['সঠিক উত্তর', 'ভুল উত্তর', 'এড়িয়ে যাওয়া'],
                            datasets: [{
                                data: [subject.correctAnswers, subject.incorrectAnswers, subject.skippedAnswers],
                                backgroundColor: ['#28a745', '#dc3545', '#6c757d'],
                                borderColor: '#fff',
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { position: 'bottom' },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const value = context.raw;
                                            const percentage = Math.round((value / total) * 100);
                                            return `${context.label}: ${value} (${percentage}%)`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
                break;
                
            case 'chapter':
                const chapterSubjectSelect = document.getElementById('chapterSubjectSelect');
                const selectedChapterSubject = chapterSubjectSelect.value;
                
                const filteredChapters = Object.entries(performanceData.chapters)
                    .filter(([_, data]) => !selectedChapterSubject || data.subject === selectedChapterSubject);
                    
                const chapterNames = filteredChapters.map(([name]) => name);
                const chapterAccuracy = filteredChapters.map(([_, data]) => {
                    return data.totalQuestions > 0 
                        ? (data.correctAnswers / data.totalQuestions * 100)
                        : 0;
                });
                
                chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: chapterNames,
                        datasets: [{
                            label: 'সঠিক উত্তরের হার (%)',
                            data: chapterAccuracy,
                            backgroundColor: chapterNames.map((_, i) => 
                                `hsl(${(i * 360 / chapterNames.length)}, 70%, 50%)`),
                            borderColor: '#fff',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        indexAxis: 'y',
                        scales: {
                            x: {
                                beginAtZero: true,
                                max: 100,
                                title: { display: true, text: 'সঠিক উত্তরের হার (%)' }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const chapter = performanceData.chapters[context.label];
                                        return [
                                            `সঠিক: ${chapter.correctAnswers}/${chapter.totalQuestions}`,
                                            `ভুল: ${chapter.incorrectAnswers}`,
                                            `এড়ানো: ${chapter.skippedAnswers}`
                                        ];
                                    }
                                }
                            }
                        }
                    }
                });
                break;
                
            case 'timeline':
                const dates = performanceData.timeline.map(item => 
                    item.date.toLocaleDateString('bn-BD'));
                const scores = performanceData.timeline.map(item => item.score);
                const totals = performanceData.timeline.map(item => item.total);
                const percentages = performanceData.timeline.map((item, i) => 
                    Math.round((item.score / item.total) * 100));
                    
                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dates,
                        datasets: [
                            {
                                label: 'স্কোর',
                                data: scores,
                                borderColor: '#6b48ff',
                                backgroundColor: 'rgba(107, 72, 255, 0.1)',
                                borderWidth: 2,
                                tension: 0.3,
                                yAxisID: 'y'
                            },
                            {
                                label: 'সর্বোচ্চ সম্ভাব্য',
                                data: totals,
                                borderColor: '#6c757d',
                                backgroundColor: 'rgba(108, 117, 125, 0.1)',
                                borderWidth: 1,
                                borderDash: [5, 5],
                                tension: 0.3,
                                yAxisID: 'y'
                            },
                            {
                                label: 'শতকরা হার (%)',
                                data: percentages,
                                borderColor: '#28a745',
                                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                                borderWidth: 2,
                                tension: 0.3,
                                yAxisID: 'y1',
                                hidden: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: { display: true, text: 'স্কোর' }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                min: 0,
                                max: 100,
                                title: { display: true, text: 'শতকরা হার (%)' },
                                grid: { drawOnChartArea: false }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    afterLabel: function(context) {
                                        const index = context.dataIndex;
                                        const item = performanceData.timeline[index];
                                        return `পরীক্ষা: ${item.examTitle}`;
                                    }
                                }
                            }
                        }
                    }
                });
                
                const timelineStatsDiv = document.getElementById('timelineStats');
                if (performanceData.timeline.length > 1) {
                    const firstScore = performanceData.timeline[0].score;
                    const lastScore = performanceData.timeline[performanceData.timeline.length - 1].score;
                    const improvement = lastScore - firstScore;
                    const improvementPercentage = firstScore > 0 
                        ? ((improvement / firstScore) * 100).toFixed(1)
                        : '∞';
                        
                    timelineStatsDiv.innerHTML = `
                        <h5>সময়রেখা বিশ্লেষণ</h5>
                        <p>প্রথম পরীক্ষার স্কোর: ${firstScore}</p>
                        <p>সর্বশেষ পরীক্ষার স্কোর: ${lastScore}</p>
                        <p class="fw-bold">উন্নতি: ${improvement} (${improvementPercentage}%)</p>
                    `;
                } else {
                    timelineStatsDiv.innerHTML = '<p>সময়রেখা বিশ্লেষণের জন্য কমপক্ষে ২টি পরীক্ষা প্রয়োজন</p>';
                }
                break;
        }
        
        performanceChartInstances[tabId] = chart;
    }

    // ==================== EXISTING DASHBOARD FUNCTIONS ====================
    const CACHE_KEY = 'userProfileData';
    const CACHE_EXPIRATION = 24 * 60 * 60 * 1000;
    const QUESTION_COUNT_CACHE_KEY = 'questionCounts';
    const QUESTION_COUNT_CACHE_EXPIRATION = 60 * 60 * 1000;

    let isDark = localStorage.getItem('theme') === 'dark';
    let isAuthenticated = false;
    let currentBattle = null;
    let battleTimer = null;
    let timeLeft = 30;
    let matchmakingListener = null;
    let battleListener = null;
    let battleListener2 = null;
    let selectedQuestions = [];
    let currentQuestionIndex = 0;
    let playerAnswers = [];
    let opponentAnswers = [];

    // Theme setup
    if (isDark) {
        document.body.setAttribute('data-theme', 'dark');
        document.getElementById('themeIcon').classList.replace('fa-moon', 'fa-sun');
    }

    function toggleTheme() {
        isDark = !isDark;
        document.body.setAttribute('data-theme', isDark ? 'dark' : 'light');
        document.getElementById('themeIcon').classList.toggle('fa-moon');
        document.getElementById('themeIcon').classList.toggle('fa-sun');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
    }

    function toggleMenu(event) {
        event.stopPropagation();
        if (isAuthenticated) {
            document.getElementById('menuDropdown').classList.toggle('show');
        } else {
            Toastify({ text: "এই ফিচারটি ব্যবহার করতে লগইন করুন!", duration: 3000, style: { background: "#dc3545" } }).showToast();
            window.location.href = 'https://dopamine-edu.github.io/auth.html';
        }
    }

    function requireLogin(url) {
        if (!isAuthenticated) {
            Toastify({ text: "এই ফিচারটি ব্যবহার করতে লগইন করুন!", duration: 3000, style: { background: "#dc3545" } }).showToast();
            window.location.href = 'https://dopamine-edu.github.io/auth.html';
            return false;
        }
        window.location.href = url;
        return true;
    }

    function getCachedUserData() {
        const cached = localStorage.getItem(CACHE_KEY);
        if (cached) {
            try {
                const cacheData = JSON.parse(cached);
                if (Date.now() - cacheData.timestamp < CACHE_EXPIRATION) {
                    return cacheData.data;
                } else {
                    localStorage.removeItem(CACHE_KEY);
                }
            } catch (e) {
                console.error('Error parsing cached user data:', e);
                localStorage.removeItem(CACHE_KEY);
            }
        }
        return null;
    }

    function setCachedUserData(userData) {
        const cacheData = {
            timestamp: Date.now(),
            data: userData
        };
        try {
            localStorage.setItem(CACHE_KEY, JSON.stringify(cacheData));
        } catch (e) {
            console.error('Error setting cache:', e);
        }
    }

    // Auth state listener
    auth.onAuthStateChanged(async user => {
        const loginBtn = document.getElementById('login-btn');
        const menuContainer = document.getElementById('menu-container');
        const userFullName = document.getElementById('userFullName');
        const lastName = document.getElementById('lastName');

        if (user) {
            isAuthenticated = true;
            loginBtn.style.display = 'none';
            menuContainer.style.display = 'block';
            let userData = getCachedUserData();
            if (userData) {
                populateUserData(userData);
            } else {
                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (userDoc.exists) {
                        userData = userDoc.data();
                        userData.email = user.email;
                        setCachedUserData(userData);
                        populateUserData(userData);
                    } else {
                        userFullName.textContent = 'ব্যবহারকারী';
                        lastName.textContent = 'ব্যবহারকারী';
                    }
                } catch (error) {
                    console.error('Error loading user data:', error);
                    userFullName.textContent = 'ব্যবহারকারী';
                    lastName.textContent = 'ব্যবহারকারী';
                }
            }
            
            // Listen for incoming challenges
            db.collection('battle_requests')
                .where('toUser', '==', user.uid)
                .where('status', '==', 'pending')
                .onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            showChallengeNotification({ ...change.doc.data(), requestId: change.doc.id });
                        }
                    });
                });

            // Setup battle listener for active battles
            setupBattleListener(user.uid);
        } else {
            isAuthenticated = false;
            loginBtn.style.display = 'inline-block';
            menuContainer.style.display = 'none';
            userFullName.textContent = 'ব্যবহারকারী';
            lastName.textContent = 'ব্যবহারকারী';
            // Clean up listeners
            if (battleListener) {
                battleListener();
                battleListener = null;
            }
            if (battleListener2) {
                battleListener2();
                battleListener2 = null;
            }
            if (matchmakingListener) {
                matchmakingListener();
                matchmakingListener = null;
            }
        }
    });

    function populateUserData(userData) {
        const fullName = userData.fullName || 'ব্যবহারকারী';
        document.getElementById('userFullName').textContent = fullName;
        document.getElementById('lastName').textContent = fullName.split(' ').pop();
        if (userData.avatar) {
            document.getElementById('userAvatar').src = userData.avatar;
        }
    }

    function logout() {
        if (isAuthenticated) {
            auth.signOut().then(() => {
                localStorage.removeItem(CACHE_KEY);
                localStorage.removeItem('theme');
                window.location.href = 'https://dopamine-edu.github.io/auth.html';
            }).catch(error => {
                Toastify({ text: "লগআউটে ত্রুটি: " + error.message, duration: 3000, style: { background: "#dc3545" } }).showToast();
            });
        }
    }

    function scrollToCustomExam() {
        if (!isAuthenticated) {
            Toastify({ text: "কাস্টম পরীক্ষা তৈরি করতে লগইন করুন!", duration: 3000, style: { background: "#dc3545" } }).showToast();
            window.location.href = 'https://dopamine-edu.github.io/auth.html';
            return;
        }
        document.getElementById('custom-exam-section').scrollIntoView({ behavior: 'smooth' });
    }

    document.addEventListener('click', (e) => {
        if (!e.target.closest('.menu-container')) {
            document.getElementById('menuDropdown').classList.remove('show');
        }
    });

    // Custom Exam JavaScript
    const subjects = {
            "Botany": [
                "Chapter 01: কোষ ও এর গঠন",
                "Chapter 02: কোষ বিভাজন",
                "Chapter 03: কোষ রসায়ন",
                "Chapter 04: অণুজীব",
                "Chapter 05: শৈবাল ও ছত্রাক",
                "Chapter 06: ব্রায়োফাইটা ও টেরেডোফাইটা",
                "Chapter 07: নগ্নবীজী ও আবৃতবীজী উদ্ভিদ",
                "Chapter 08: টিস্যু ও টিস্যুতন্ত্র",
                "Chapter 09: উদ্ভিদ শারীরতত্ত্ব",
                "Chapter 10: উদ্ভিদ প্রজনন",
                "Chapter 11: জীবপ্রযুক্তি"
            ],
            "Zoology": [
                "Chapter 01: প্রাণীর বিভিন্নতা ও শ্রেণিবিন্যাস",
                "Chapter 02: প্রাণীর পরিচিতি",
                "Chapter 03: পরিপাক ও শোষণ",
                "Chapter 04: রক্ত সঞ্চালন",
                "Chapter 05: শ্বাসক্রিয়া ও শ্বসন",
                "Chapter 06: বর্জ্য ও নিষ্কাশন",
                "Chapter 07: চলন ও অঙ্গচালনা",
                "Chapter 08: সমন্বয় ও নিয়ন্ত্রণ",
                "Chapter 09: মানব জীবনের ধারাবাহিকতা",
                "Chapter 10: মানবদেহের প্রতিরক্ষা",
                "Chapter 11: জীনতত্ত্ব ও বিবর্তন"
            ],
            "Physics 1st": [
                "Chapter 01: ভৌত জগৎ ও পরিমাপ",
                "Chapter 02: ভেক্টর",
                "Chapter 04: নিউটোনিয়ান বলবিদ্যা",
                "Chapter 05: কাজ, শক্তি ও ক্ষমতা",
                "Chapter 06: মহাকর্ষ ও অভিকর্ষ",
                "Chapter 07: পদার্থের গাঠনিক ধর্ম",
                "Chapter 08: পর্যাবৃত্ত গতি",
                "Chapter 10: আদর্শ গ্যাস ও গ্যাসের গতিতত্ত্ব"
            ],
            "Physics 2nd": [
                "Chapter 01: তাপগতিবিদ্যা",
                "Chapter 02: স্থির তড়িৎ",
                "Chapter 03: চলতড়িৎ",
                "Chapter 07: ভৌত আলোকবিজ্ঞান",
                "Chapter 08: আধুনিক পদার্থবিজ্ঞানের সূচনা",
                "Chapter 09: পরমাণুর মডেল এবং নিউক্লিয়ার পদার্থবিজ্ঞান",
                "Chapter 10: সেমিকন্ডাক্টর ও ইলেকট্রনিক্স"
            ],
            "Chemistry 1st": [
                "Chapter 01: ল্যাবরেটরির নিরাপদ ব্যবহার",
                "Chapter 02: গুণগত রসায়ন",
                "Chapter 03: মৌলের পর্যায়বৃত্ত ধর্ম",
                "Chapter 04: রাসায়নিক পরিবর্তন",
                "Chapter 05: কর্মমুখী রসায়ন"
            ],
            "Chemistry 2nd": [
                "Chapter 01: পরিবেশ রসায়ন",
                "Chapter 02: জৈব রসায়ন",
                "Chapter 03: পরিমাণগত রসায়ন",
                "Chapter 04: তড়িৎ রসায়ন",
                "Chapter 05: অর্থনৈতিক রসায়ন"
            ],
            "Higher Math 1st": [
                "Chapter 01: ম্যাট্রিক্স ও নির্ণায়ক",
                "Chapter 03: সরলরেখা",
                "Chapter 04: বৃত্ত",
                "Chapter 07: সংযুক্ত কোণের ত্রিকোণমিতিক অনুপাত",
                "Chapter 09: অন্তরীকরণ",
                "Chapter 10: যোগজীকরণ"
            ],
            "Higher Math 2nd": [
                "Chapter 03: জটিল সংখ্যা",
                "Chapter 04: বহুপদী ও বহুপদী সমীকরণ",
                "Chapter 06: কণিক",
                "Chapter 07: বিপরীত ত্রিকোণমিতিক ফাংশন ও ত্রিকোণমিতিক সমীকরণ",
                "Chapter 08: স্থিতিবিদ্যা",
                "Chapter 09: সমতলে বস্তুকণার গতি"
            ],
            "English": [],
            "Bangla": []
    };

    document.getElementById('timeSelect').addEventListener('change', function() {
        const customTimeInput = document.getElementById('customTimeInput');
        if (this.value === 'custom') {
            customTimeInput.style.display = 'block';
        } else {
            customTimeInput.style.display = 'none';
            updateSummary();
        }
    });

    document.getElementById('numQuestions').addEventListener('input', updateSummary);
    document.getElementById('timeSelect').addEventListener('change', updateSummary);
    document.getElementById('customTime').addEventListener('input', updateSummary);
    document.getElementById('negativeMarking').addEventListener('input', updateSummary);

    function updateSummary() {
        const numQuestions = document.getElementById('numQuestions').value || '0';
        const timeSelect = document.getElementById('timeSelect');
        const customTime = document.getElementById('customTime').value;
        const negativeMarking = document.getElementById('negativeMarking').value || '0';
        
        document.getElementById('summaryQuestions').textContent = numQuestions;
        
        let timeDisplay;
        if (timeSelect.value === 'custom' && customTime) {
            timeDisplay = `${customTime} মিনিট`;
        } else if (timeSelect.value !== 'custom') {
            timeDisplay = `${timeSelect.options[timeSelect.selectedIndex].text}`;
        } else {
            timeDisplay = '০ মিনিট';
        }
        document.getElementById('summaryTime').textContent = timeDisplay;
        
        document.getElementById('summaryNegative').textContent = negativeMarking;
    }

    function sanitizeFileName(name) {
    if (!name) return 'default'; // Fallback if name is undefined/null
    return name.replace(/\s+/g, '-').replace(/[^a-zA-Z0-9\u0980-\u09FF-]/g, '');
}

    async function loadQuestionsFromJSON(subject, chapter) {
        if (!subject || !chapter) {
            console.error("Missing subject or chapter:", subject, chapter);
            return [];
        }
    
        try {
            const sanitizedSubject = subject.replace(/\s+/g, '-').replace(/[^a-zA-Z0-9\u0980-\u09FF-]/g, '');
            const sanitizedChapter = chapter.replace(/^Chapter \d+:\s*/, '')
                                          .replace(/\s+/g, '-')
                                          .replace(/[^a-zA-Z0-9\u0980-\u09FF-]/g, '');
            
            const filePath = `./questions/subjects/${sanitizedSubject}/${sanitizedChapter}.json`;
            
            const response = await fetch(filePath);
            if (!response.ok) throw new Error("File not found");
            
            const data = await response.json();
            return Array.isArray(data) ? data : [];
        } catch (error) {
            console.error(`Error loading ${subject} - ${chapter}:`, error);
            return [];
        }
    }

async function fetchQuestionCounts() {
    // 1. Check cached data first
    const cachedCounts = localStorage.getItem(QUESTION_COUNT_CACHE_KEY);
    if (cachedCounts) {
        try {
            const { data, timestamp } = JSON.parse(cachedCounts);
            if (Date.now() - timestamp < QUESTION_COUNT_CACHE_EXPIRATION) {
                console.log('Using cached question counts');
                return data; // Return cached data if valid
            }
        } catch (e) {
            console.error('Error parsing cached question counts:', e);
            localStorage.removeItem(QUESTION_COUNT_CACHE_KEY);
        }
    }

    // 2. Initialize data structures
    const questionCounts = {};
    const chapterQuestionCounts = {};

    // 3. Process each subject and chapter
    for (const subject in subjects) {
        if (!subjects[subject] || subjects[subject].length === 0) {
            console.warn(`No chapters found for subject: ${subject}`);
            continue;
        }

        questionCounts[subject] = 0;
        chapterQuestionCounts[subject] = []; // Initialize array for chapters

        for (const chapter of subjects[subject]) {
            try {
                const questions = await loadQuestionsFromJSON(subject, chapter);
                const count = questions?.length || 0; // Handle undefined questions
                
                questionCounts[subject] += count;
                chapterQuestionCounts[subject].push(count);
                
                console.log(`Loaded ${count} questions for ${subject} - ${chapter}`);
            } catch (error) {
                console.error(`Failed to load ${subject} - ${chapter}:`, error);
                chapterQuestionCounts[subject].push(0); // Push 0 if loading fails
            }
        }
    }

    // 4. Cache the results
    try {
        localStorage.setItem(QUESTION_COUNT_CACHE_KEY, JSON.stringify({
            data: { questionCounts, chapterQuestionCounts },
            timestamp: Date.now()
        }));
    } catch (e) {
        console.error('Failed to cache question counts:', e);
    }

    // 5. Return the counts
    return { questionCounts, chapterQuestionCounts };
}
        function createSubjectBox(subject, questionCount, chapterCounts) {
            const subjectBox = document.createElement('div');
            subjectBox.className = 'subject-box';
            subjectBox.innerHTML = `
                <div class="subject-header">
                    <input type="checkbox" class="form-check-input" onchange="toggleSubject(this)">
                    <span class="subject-name">${subject}</span>
                    <span class="question-count">${questionCount} প্রশ্ন</span>
                    <i class="fas fa-chevron-down arrow"></i>
                </div>
                <div class="chapter-list">
                    <!-- Chapters will be inserted here -->
                </div>
            `;
        
            // Insert chapters
            const chapterList = subjectBox.querySelector('.chapter-list');
            subjects[subject].forEach((chapter, index) => {
                const chapterBox = document.createElement('div');
                chapterBox.className = 'chapter-box';
                // Add dataset attributes here
                chapterBox.dataset.subject = subject;
                chapterBox.dataset.originalChapter = chapter;
                chapterBox.innerHTML = `
                    <input type="checkbox" class="form-check-input" onchange="toggleChapter(this)">
                    <span class="chapter-name">${chapter.replace(/^Chapter \d+:\s*/, '')}</span>
                    <span class="chapter-question-count">${chapterCounts[subject]?.[index] || 0} প্রশ্ন</span>
                `;
                chapterList.appendChild(chapterBox);
            });
        
            // Add click event to expand/collapse
            const subjectHeader = subjectBox.querySelector('.subject-header');
            const arrow = subjectBox.querySelector('.arrow');
            
            subjectHeader.addEventListener('click', (e) => {
                if (e.target.tagName !== 'INPUT') { // Ignore checkbox clicks
                    chapterList.classList.toggle('show');
                    arrow.classList.toggle('active');
                }
            });
        
            return subjectBox;
        }

    function toggleSubject(checkbox) {
        const subjectBox = checkbox.parentElement.parentElement;
        const chapterList = subjectBox.querySelector('.chapter-list');
        const arrow = subjectBox.querySelector('.arrow');
        const chapterCheckboxes = chapterList.querySelectorAll('.form-check-input');
        
        arrow.style.display = checkbox.checked ? 'block' : 'none';
        chapterCheckboxes.forEach(chapterCheckbox => {
            chapterCheckbox.checked = checkbox.checked;
        });
        updateSummary();
    }

    function toggleChapters(header) {
        const chapterList = header.parentElement.querySelector('.chapter-list');
        const arrow = header.querySelector('.arrow');
        chapterList.classList.toggle('show');
        arrow.classList.toggle('active');
    }

    function toggleChapter(checkbox) {
        updateSummary();
    }

async function populateSubjects() {
    try {
        const { questionCounts, chapterQuestionCounts } = await fetchQuestionCounts();
        const subjectSelection = document.getElementById('subjectSelection');
        subjectSelection.innerHTML = '';

        for (const subject in subjects) {
            // Default to 0 if counts are missing
            const totalQuestions = questionCounts[subject] || 0;
            const chapterCounts = chapterQuestionCounts[subject] || [];

            const subjectBox = createSubjectBox(subject, totalQuestions, chapterQuestionCounts);
            subjectSelection.appendChild(subjectBox);
        }
    } catch (error) {
        console.error("Error populating subjects:", error);
        Toastify({ 
            text: "বিষয়গুলো লোড করতে ত্রুটি: " + error.message, 
            duration: 3000, 
            style: { background: "#dc3545" } 
        }).showToast();
    }
}

document.getElementById("customExamForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    if (!isAuthenticated) {
        Toastify({ text: "কাস্টম পরীক্ষা তৈরি করতে লগইন করুন!", duration: 3000, style: { background: "#dc3545" } }).showToast();
        window.location.href = 'https://dopamine-edu.github.io/auth.html';
        return;
    }

    const submitButton = e.target.querySelector('.btn-primary');
    submitButton.disabled = true;
    submitButton.textContent = 'তৈরি হচ্ছে...';
    const loadingDiv = document.getElementById("loading-spinner");
    loadingDiv.style.display = "block";

    const numQuestions = parseInt(document.getElementById("numQuestions").value);
    const timeSelect = document.getElementById("timeSelect");
    const customTime = parseInt(document.getElementById("customTime").value);
    const negativeMarking = parseFloat(document.getElementById("negativeMarking").value);
    
    // Get selected chapters with their question counts
    const selectedChaptersWithCounts = [];
    document.querySelectorAll('.chapter-box .form-check-input:checked').forEach(checkbox => {
        const chapterBox = checkbox.closest('.chapter-box');
        const questionCountElement = chapterBox.querySelector('.chapter-question-count');
        const questionCount = parseInt(questionCountElement.textContent) || 0;
        
        selectedChaptersWithCounts.push({
            subject: chapterBox.dataset.subject,
            chapter: chapterBox.dataset.originalChapter,
            questionCount: questionCount
        });
    });

    if (selectedChaptersWithCounts.length === 0) {
        Toastify({ text: "অন্তত একটি অধ্যায় নির্বাচন করুন!", duration: 3000, style: { background: "#dc3545" } }).showToast();
        loadingDiv.style.display = "none";
        submitButton.disabled = false;
        submitButton.textContent = 'পরীক্ষা শুরু';
        return;
    }

    try {
        // Load questions from all selected chapters
        const chapterQuestions = [];
        for (const { subject, chapter } of selectedChaptersWithCounts) {
            const questions = await loadQuestionsFromJSON(subject, chapter);
            chapterQuestions.push({
                subject,
                chapter,
                questions: questions.map((q, idx) => ({ ...q, id: idx }))
            });
        }

        // Calculate how many questions to take from each chapter
        const questionsPerChapter = Math.ceil(numQuestions / selectedChaptersWithCounts.length);
        const selectedQuestions = [];

        // Take questions from each chapter proportionally
        for (const chapterData of chapterQuestions) {
            const availableQuestions = chapterData.questions.length;
            const questionsToTake = Math.min(questionsPerChapter, availableQuestions);
            
            // Shuffle and take questions
            const shuffled = [...chapterData.questions].sort(() => 0.5 - Math.random());
            const takenQuestions = shuffled.slice(0, questionsToTake);
            
            takenQuestions.forEach(q => {
                selectedQuestions.push({
                    subject: chapterData.subject,
                    chapter: chapterData.chapter,
                    id: q.id
                });
            });
        }

        // If we have more questions than needed, randomly remove some
        while (selectedQuestions.length > numQuestions) {
            const randomIndex = Math.floor(Math.random() * selectedQuestions.length);
            selectedQuestions.splice(randomIndex, 1);
        }

        // If we have fewer questions than needed, add more from chapters with remaining questions
        if (selectedQuestions.length < numQuestions) {
            const remainingNeeded = numQuestions - selectedQuestions.length;
            let added = 0;
            let attempts = 0;
            
            while (added < remainingNeeded && attempts < 100) {
                attempts++;
                for (const chapterData of chapterQuestions) {
                    if (added >= remainingNeeded) break;
                    
                    // Find questions not already selected
                    const existingIds = selectedQuestions
                        .filter(q => q.subject === chapterData.subject && q.chapter === chapterData.chapter)
                        .map(q => q.id);
                    
                    const availableQuestions = chapterData.questions
                        .filter(q => !existingIds.includes(q.id));
                    
                    if (availableQuestions.length > 0) {
                        const randomQuestion = availableQuestions[
                            Math.floor(Math.random() * availableQuestions.length)
                        ];
                        
                        selectedQuestions.push({
                            subject: chapterData.subject,
                            chapter: chapterData.chapter,
                            id: randomQuestion.id
                        });
                        added++;
                    }
                }
            }
        }

        // SHUFFLE ALL SELECTED QUESTIONS TO RANDOMIZE THE ORDER
        for (let i = selectedQuestions.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [selectedQuestions[i], selectedQuestions[j]] = [selectedQuestions[j], selectedQuestions[i]];
        }

        const subjectsList = [...new Set(selectedChaptersWithCounts.map(item => item.subject))];
        const chaptersList = selectedChaptersWithCounts.map(item => item.chapter);
        const time = timeSelect.value === 'custom' ? customTime : parseInt(timeSelect.value);

        const examDocRef = await db.collection("exams").add({
            title: `কাস্টম পরীক্ষা - ${chaptersList.map(ch => ch.replace(/^Chapter \d+:\s*/, '')).join(", ")}`,
            duration: time,
            marksPerQuestion: 1,
            negativeMark: negativeMarking,
            lastDate: null,
            questions: selectedQuestions,
            subjects: subjectsList,
            chapters: chaptersList,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        loadingDiv.style.display = "none";
        submitButton.disabled = false;
        submitButton.textContent = 'পরীক্ষা শুরু';
        Toastify({ text: "কাস্টম পরীক্ষা সফলভাবে তৈরি হয়েছে!", duration: 3000, style: { background: "#6b48ff" } }).showToast();
        window.location.href = `quiz.html?examId=${examDocRef.id}`;
    } catch (error) {
        loadingDiv.style.display = "none";
        submitButton.disabled = false;
        submitButton.textContent = 'পরীক্ষা শুরু';
        console.error("কাস্টম পরীক্ষা তৈরিতে ত্রুটি:", error);
        Toastify({ text: "পরীক্ষা তৈরিতে ত্রুটি: " + error.message, duration: 3000, style: { background: "#dc3545" } }).showToast();
    }
});

    // Battle modal functions
    function openBattleModal() {
        if (!isAuthenticated) {
            Toastify({ text: "কুইজ ব্যাটল খেলতে লগইন করুন!", duration: 3000, style: { background: "#dc3545" } }).showToast();
            window.location.href = 'https://dopamine-edu.github.io/auth.html';
            return;
        }
        document.getElementById('battleModal').style.display = 'block';
        loadFriendList();
        loadBattleHistory();
        const user = auth.currentUser;
        if (user) {
            setupBattleListener(user.uid);
        }
    }

    function closeBattleModal() {
        document.getElementById('battleModal').style.display = 'none';
        if (matchmakingListener) {
            matchmakingListener();
            matchmakingListener = null;
        }
        if (battleListener) {
            battleListener();
            battleListener = null;
        }
        if (battleListener2) {
            battleListener2();
            battleListener2 = null;
        }
    }

    function openBattleTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });

        document.getElementById(tabId).classList.add('active');
        document.querySelector(`[onclick="openBattleTab('${tabId}')"]`).classList.add('active');
    }

    async function loadFriendList() {
        const user = auth.currentUser;
        if (!user) return;

        try {
            const snapshot = await db.collection('users')
                .where('uid', '!=', user.uid)
                .limit(20)
                .get();

            const friendList = document.getElementById('friendList');
            friendList.innerHTML = '';

            if (snapshot.empty) {
                friendList.innerHTML = '<p>কোনো বন্ধু পাওয়া যায়নি</p>';
                return;
            }

            snapshot.forEach(doc => {
                const friend = doc.data();
                const friendItem = document.createElement('div');
                friendItem.className = 'friend-item';
                friendItem.innerHTML = `
                    <img src="${friend.avatar || 'https://cdn-icons-png.flaticon.com/512/4333/4333609.png'}" 
                         class="friend-avatar" 
                         onerror="this.src='https://via.placeholder.com/45'">
                    <span>${friend.fullName || 'ব্যবহারকারী'}</span>
                `;
                friendItem.onclick = () => sendChallenge(friend.uid);
                friendList.appendChild(friendItem);
            });
        } catch (error) {
            console.error("Error loading friends:", error);
            Toastify({ text: "বন্ধু লোড করতে ত্রুটি: " + error.message, duration: 3000, style: { background: "#dc3545" } }).showToast();
        }
    }

    async function loadBattleHistory() {
        const user = auth.currentUser;
        if (!user) return;

        try {
            const snapshot1 = await db.collection('battles')
                .where('status', '==', 'completed')
                .where('player1', '==', user.uid)
                .orderBy('endTime', 'desc')
                .limit(10)
                .get();

            const snapshot2 = await db.collection('battles')
                .where('status', '==', 'completed')
                .where('player2', '==', user.uid)
                .orderBy('endTime', 'desc')
                .limit(10)
                .get();

            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';

            const battles = [];
            snapshot1.forEach(doc => battles.push({ id: doc.id, ...doc.data() }));
            snapshot2.forEach(doc => battles.push({ id: doc.id, ...doc.data() }));

            const limitedBattles = battles.sort((a, b) => (b.endTime?.toMillis() || 0) - (a.endTime?.toMillis() || 0)).slice(0, 10);

            if (limitedBattles.length === 0) {
                historyList.innerHTML = '<p>কোনো ইতিহাস পাওয়া যায়নি</p>';
                return;
            }

            for (const battle of limitedBattles) {
                const opponentId = battle.player1 === user.uid ? battle.player2 : battle.player1;
                const opponentDoc = await db.collection('users').doc(opponentId).get();
                const opponent = opponentDoc.data() || { fullName: 'ব্যবহারকারী', avatar: 'https://cdn-icons-png.flaticon.com/512/4333/4333609.png' };

                const isWinner = (battle.player1 === user.uid && battle.scores.player1 > battle.scores.player2) ||
                                (battle.player2 === user.uid && battle.scores.player2 > battle.scores.player1);

                const historyItem = document.createElement('div');
                historyItem.className = `history-item ${isWinner ? 'win' : 'lose'}`;
                historyItem.innerHTML = `
                    <div class="history-opponent">
                        <img src="${opponent.avatar || 'https://cdn-icons-png.flaticon.com/512/4333/4333609.png'}" 
                             class="history-avatar"
                             onerror="this.src='https://via.placeholder.com/35'">
                        <span>${opponent.fullName}</span>
                    </div>
                    <div>
                        <span>${battle.scores.player1}</span> - 
                        <span>${battle.scores.player2}</span>
                    </div>
                `;
                historyList.appendChild(historyItem);
            }
        } catch (error) {
            console.error("Error loading battle history:", error);
            Toastify({ text: "ইতিহাস লোড করতে ত্রুটি: " + error.message, duration: 3000, style: { background: "#dc3545" } }).showToast();
        }
    }

    function searchFriends() {
        const searchTerm = document.getElementById('friendSearch').value.toLowerCase();
        const friends = document.querySelectorAll('.friend-item');

        friends.forEach(friend => {
            const name = friend.textContent.toLowerCase();
            friend.style.display = name.includes(searchTerm) ? 'flex' : 'none';
        });
    }

    function sendChallenge(friendId) {
        const user = auth.currentUser;
        if (!user) return;

        db.collection('battle_requests').add({
            fromUser: user.uid,
            toUser: friendId,
            status: 'pending',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
            Toastify({ text: "চ্যালেঞ্জ পাঠানো হয়েছে!", duration: 3000, style: { background: "#6b48ff" } }).showToast();
        }).catch(error => {
            Toastify({ text: "চ্যালেঞ্জ পাঠাতে ত্রুটি: " + error.message, duration: 3000, style: { background: "#dc3545" } }).showToast();
            console.error("Error sending challenge:", error);
        });
    }

    function showChallengeNotification(request) {
        Toastify({
            text: `আপনি ${request.fromUser} থেকে একটি ব্যাটল চ্যালেঞ্জ পেয়েছেন!`,
            duration: 5000,
            style: { background: "#6b48ff" },
            close: true,
            onClick: () => {
                db.collection('battle_requests').doc(request.requestId).update({
                    status: 'accepted'
                }).then(() => startBattle(request.fromUser, auth.currentUser.uid));
            }
        }).showToast();
    }

    async function findOpponent() {
        const user = auth.currentUser;
        if (!user) return;

        const statusDiv = document.getElementById('matchmakingStatus');
        statusDiv.textContent = 'প্রতিপক্ষ খুঁজছি...';

        try {
            const existingRequest = await db.collection('battle_requests')
                .where('status', '==', 'pending')
                .where('toUser', '==', null)
                .where('fromUser', '!=', user.uid)
                .limit(1)
                .get();

            if (!existingRequest.empty) {
                const request = existingRequest.docs[0];
                await db.collection('battle_requests').doc(request.id).update({
                    toUser: user.uid,
                    status: 'accepted'
                });
                startBattle(request.data().fromUser, user.uid);
                return;
            }

            const requestRef = await db.collection('battle_requests').add({
                fromUser: user.uid,
                toUser: null,
                status: 'pending',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            matchmakingListener = db.collection('battle_requests')
                .doc(requestRef.id)
                .onSnapshot(doc => {
                    if (doc.exists && doc.data().status === 'accepted') {
                        statusDiv.textContent = 'প্রতিপক্ষ পাওয়া গেছে!';
                        startBattle(user.uid, doc.data().toUser);
                    }
                });
        } catch (error) {
            statusDiv.textContent = 'প্রতিপক্ষ খুঁজতে ত্রুটি';
            Toastify({ text: "প্রতিপক্ষ খুঁজতে ত্রুটি: " + error.message, duration: 3000, style: { background: "#dc3545" } }).showToast();
            console.error("Error finding opponent:", error);
        }
    }

    async function startBattle(player1Id, player2Id) {
        try {
            const subjectsToInclude = ['Botany', 'Zoology', 'Physics 1st', 'Physics 2nd', 'Chemistry 1st', 'Chemistry 2nd'];
            const allQuestions = [];

            for (const subject of subjectsToInclude) {
                for (const chapter of subjects[subject]) {
                    const questions = await loadQuestionsFromJSON(subject, chapter);
                    questions.forEach((q, index) => {
                        allQuestions.push({ id: index, subject, chapter });
                    });
                }
            }

            selectedQuestions = allQuestions.sort(() => 0.5 - Math.random()).slice(0, 10);

            const battleRef = await db.collection('battles').add({
                player1: player1Id,
                player2: player2Id,
                status: 'active',
                questions: selectedQuestions,
                scores: { 
                    player1: 0, 
                    player2: 0 
                },
                answers: { 
                    player1: [], 
                    player2: [] 
                },
                currentQuestion: 0,
                startTime: firebase.firestore.FieldValue.serverTimestamp()
            });

            currentBattle = battleRef.id;
            document.getElementById('battleModal').style.display = 'none';
            document.getElementById('battleScreen').style.display = 'block';
            loadBattleQuestion();
        } catch (error) {
            console.error("Error starting battle:", error);
            Toastify({ text: "ব্যাটল শুরু করতে ত্রুটি: " + error.message, duration: 3000, style: { background: "#dc3545" } }).showToast();
        }
    }

    async function loadBattleQuestion() {
        if (!currentBattle) return;

        try {
            const battleDoc = await db.collection('battles').doc(currentBattle).get();
            if (!battleDoc.exists) {
                endBattle();
                return;
            }

            const battleData = battleDoc.data();
            currentQuestionIndex = battleData.currentQuestion || 0;

            if (currentQuestionIndex >= selectedQuestions.length) {
                endBattle();
                return;
            }

            const questionData = selectedQuestions[currentQuestionIndex];
            const questions = await loadQuestionsFromJSON(questionData.subject, questionData.chapter);
            const question = questions[questionData.id];

            document.getElementById('battleQuestionText').textContent = question.question;
            const options = document.querySelectorAll('#battleOptions .option');
            question.options.forEach((option, index) => {
                options[index].textContent = option;
                options[index].classList.remove('correct', 'incorrect');
                options[index].disabled = false;
            });

            timeLeft = 30;
            document.getElementById('questionTimer').textContent = timeLeft;
            if (battleTimer) clearInterval(battleTimer);
            battleTimer = setInterval(() => {
                timeLeft--;
                document.getElementById('questionTimer').textContent = timeLeft;
                if (timeLeft <= 0) {
                    submitAnswer(null);
                }
            }, 1000);

            const user = auth.currentUser;
            if (user) {
                const playerField = battleData.player1 === user.uid ? 'player1' : 'player2';
                playerAnswers = battleData.answers[playerField] || [];
                opponentAnswers = battleData.answers[playerField === 'player1' ? 'player2' : 'player1'] || [];
            }
        } catch (error) {
            Toastify({ text: "প্রশ্ন লোড করতে ত্রুটি: " + error.message, duration: 3000, style: { background: "#dc3545" } }).showToast();
            console.error("Error loading battle question:", error);
        }
    }

    async function submitAnswer(optionIndex) {
        if (!currentBattle || optionIndex === null) {
            clearInterval(battleTimer);
            currentQuestionIndex++;
            try {
                await db.collection('battles').doc(currentBattle).update({
                    currentQuestion: currentQuestionIndex
                });
                loadBattleQuestion();
            } catch (error) {
                console.error("Error moving to next question:", error);
            }
            return;
        }

        try {
            const battleRef = db.collection('battles').doc(currentBattle);
            const battleDoc = await battleRef.get();
            const battleData = battleDoc.data();
            
            const questionData = selectedQuestions[currentQuestionIndex];
            const questions = await loadQuestionsFromJSON(questionData.subject, questionData.chapter);
            const question = questions[questionData.id];
            
            const isCorrect = optionIndex === question.correctOption;
            const user = auth.currentUser;
            const playerField = battleData.player1 === user.uid ? 'player1' : 'player2';
            
            await db.runTransaction(async (transaction) => {
                const freshDoc = await transaction.get(battleRef);
                const freshData = freshDoc.data();
                
                const updatedAnswers = [...(freshData.answers[playerField] || []), 
                    { questionIndex: currentQuestionIndex, answer: optionIndex, correct: isCorrect }];
                
                const updateData = {
                    [`answers.${playerField}`]: updatedAnswers
                };
                
                if (isCorrect) {
                    updateData[`scores.${playerField}`] = firebase.firestore.FieldValue.increment(1);
                }
                
                transaction.update(battleRef, updateData);
            });
            
            const options = document.querySelectorAll('#battleOptions .option');
            options.forEach((option, idx) => {
                option.disabled = true;
                if (idx === question.correctOption) {
                    option.classList.add('correct');
                } else if (idx === optionIndex) {
                    option.classList.add('incorrect');
                }
            });
            
            if (isCorrect) {
                const scoreElement = document.getElementById(`${playerField}Score`);
                const currentScore = parseInt(scoreElement.textContent);
                scoreElement.textContent = currentScore + 1;
            }
            
            clearInterval(battleTimer);
            setTimeout(async () => {
                currentQuestionIndex++;
                await battleRef.update({ currentQuestion: currentQuestionIndex });
                loadBattleQuestion();
            }, 2000);
            
        } catch (error) {
            console.error("Error submitting answer:", error);
            Toastify({ 
                text: "উত্তর জমা দিতে ত্রুটি: " + error.message, 
                duration: 3000, 
                style: { background: "#dc3545" } 
            }).showToast();
        }
    }

    async function endBattle() {
        clearInterval(battleTimer);
        if (!currentBattle) return;

        try {
            const battleDoc = await db.collection('battles').doc(currentBattle).get();
            const battleData = battleDoc.data();
            const user = auth.currentUser;
            const playerField = battleData.player1 === user.uid ? 'player1' : 'player2';
            const opponentField = playerField === 'player1' ? 'player2' : 'player1';

            const playerScore = battleData.scores[playerField] || 0;
            const opponentScore = battleData.scores[opponentField] || 0;
            const correctCount = playerAnswers.filter(a => a.correct).length;

            document.getElementById('finalPlayer1Score').textContent = battleData.scores.player1 || 0;
            document.getElementById('finalPlayer2Score').textContent = battleData.scores.player2 || 0;
            document.getElementById('correctAnswers').textContent = correctCount;
            document.getElementById('resultTitle').textContent = playerScore > opponentScore ? 'আপনি জিতেছেন!' : playerScore < opponentScore ? 'আপনি হেরেছেন!' : 'ড্র!';
            document.getElementById('battleResult').style.display = 'block';

            await db.collection('battles').doc(currentBattle).update({
                status: 'completed',
                endTime: firebase.firestore.FieldValue.serverTimestamp()
            });

            currentBattle = null;
            selectedQuestions = [];
            currentQuestionIndex = 0;
            playerAnswers = [];
            opponentAnswers = [];
        } catch (error) {
            Toastify({ text: "ব্যাটল শেষ করতে ত্রুটি: " + error.message, duration: 3000, style: { background: "#dc3545" } }).showToast();
            console.error("Error ending battle:", error);
        }
    }

    function closeBattleScreen() {
        document.getElementById('battleScreen').style.display = 'none';
        document.getElementById('battleResult').style.display = 'none';
        if (battleListener) {
            battleListener();
            battleListener = null;
        }
        if (battleListener2) {
            battleListener2();
            battleListener2 = null;
        }
        if (matchmakingListener) {
            matchmakingListener();
            matchmakingListener = null;
        }
        openBattleModal();
    }

    function setupBattleListener(userId) {
        try {
            battleListener = db.collection('battles')
                .where('player1', '==', userId)
                .where('status', '==', 'active')
                .onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'modified') {
                            const battleData = change.doc.data();
                            document.getElementById('player1Score').textContent = battleData.scores.player1 || 0;
                            document.getElementById('player2Score').textContent = battleData.scores.player2 || 0;
                        }
                    });
                });
            
            battleListener2 = db.collection('battles')
                .where('player2', '==', userId)
                .where('status', '==', 'active')
                .onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'modified') {
                            const battleData = change.doc.data();
                            document.getElementById('player2Score').textContent = battleData.scores.player2 || 0;
                            document.getElementById('player1Score').textContent = battleData.scores.player1 || 0;
                        }
                    });
                });
        } catch (error) {
            console.error("Error setting up battle listener:", error);
            Toastify({ text: "ব্যাটল লিসেনার সেটআপে ত্রুটি: " + error.message, duration: 3000, style: { background: "#dc3545" } }).showToast();
        }
    }

    async function updatePlayerInfo(battleData) {
        try {
            const player1Doc = await db.collection('users').doc(battleData.player1).get();
            const player2Doc = await db.collection('users').doc(battleData.player2).get();
            
            document.getElementById('player1Name').textContent = player1Doc.data()?.fullName || 'Player 1';
            document.getElementById('player1Avatar').src = player1Doc.data()?.avatar || 'https://cdn-icons-png.flaticon.com/512/4333/4333609.png';
            document.getElementById('player1Score').textContent = battleData.scores.player1 || 0;

            document.getElementById('player2Name').textContent = player2Doc.data()?.fullName || 'Player 2';
            document.getElementById('player2Avatar').src = player2Doc.data()?.avatar || 'https://cdn-icons-png.flaticon.com/512/4333/4333609.png';
            document.getElementById('player2Score').textContent = battleData.scores.player2 || 0;
        } catch (error) {
            console.error("Error updating player info:", error);
            Toastify({ text: "প্লেয়ার তথ্য লোডে ত্রুটি: " + error.message, duration: 3000, style: { background: "#dc3545" } }).showToast();
        }
    }
    // Initialize subjects on page load
    populateSubjects();
</script>
</body>
</html>
